<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>gotran.codegeneration.codegenerators &mdash; gotran 2019.0.0 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> gotran
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Programmers reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../gotran.html">gotran package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">gotran</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>gotran.codegeneration.codegenerators</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for gotran.codegeneration.codegenerators</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (C) 2012 Johan Hake</span>
<span class="c1">#</span>
<span class="c1"># This file is part of Gotran.</span>
<span class="c1">#</span>
<span class="c1"># Gotran is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU Lesser General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># Gotran is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="c1"># GNU Lesser General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU Lesser General Public License</span>
<span class="c1"># along with Gotran. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>

<span class="kn">from</span> <span class="nn">modelparameters.codegeneration</span> <span class="kn">import</span> <span class="n">ccode</span>
<span class="kn">from</span> <span class="nn">modelparameters.codegeneration</span> <span class="kn">import</span> <span class="n">cppcode</span>
<span class="kn">from</span> <span class="nn">modelparameters.codegeneration</span> <span class="kn">import</span> <span class="n">juliacode</span>
<span class="kn">from</span> <span class="nn">modelparameters.codegeneration</span> <span class="kn">import</span> <span class="n">matlabcode</span>
<span class="kn">from</span> <span class="nn">modelparameters.codegeneration</span> <span class="kn">import</span> <span class="n">pythoncode</span>
<span class="kn">from</span> <span class="nn">modelparameters.logger</span> <span class="kn">import</span> <span class="n">error</span>
<span class="kn">from</span> <span class="nn">modelparameters.logger</span> <span class="kn">import</span> <span class="n">warning</span>
<span class="kn">from</span> <span class="nn">modelparameters.parameterdict</span> <span class="kn">import</span> <span class="n">ParameterDict</span>
<span class="kn">from</span> <span class="nn">modelparameters.utils</span> <span class="kn">import</span> <span class="n">check_arg</span>
<span class="kn">from</span> <span class="nn">modelparameters.utils</span> <span class="kn">import</span> <span class="n">check_kwarg</span>

<span class="kn">from</span> <span class="nn">..common.options</span> <span class="kn">import</span> <span class="n">parameters</span>
<span class="kn">from</span> <span class="nn">..model.expressions</span> <span class="kn">import</span> <span class="n">AlgebraicExpression</span>
<span class="kn">from</span> <span class="nn">..model.expressions</span> <span class="kn">import</span> <span class="n">Expression</span>
<span class="kn">from</span> <span class="nn">..model.expressions</span> <span class="kn">import</span> <span class="n">IndexedExpression</span>
<span class="kn">from</span> <span class="nn">..model.expressions</span> <span class="kn">import</span> <span class="n">ParameterIndexedExpression</span>
<span class="kn">from</span> <span class="nn">..model.expressions</span> <span class="kn">import</span> <span class="n">StateIndexedExpression</span>
<span class="kn">from</span> <span class="nn">..model.ode</span> <span class="kn">import</span> <span class="n">ODE</span>
<span class="kn">from</span> <span class="nn">..model.odeobjects</span> <span class="kn">import</span> <span class="n">Comment</span>
<span class="kn">from</span> <span class="nn">..model.odeobjects</span> <span class="kn">import</span> <span class="n">ODEObject</span>
<span class="kn">from</span> <span class="nn">.algorithmcomponents</span> <span class="kn">import</span> <span class="n">componentwise_derivative</span>
<span class="kn">from</span> <span class="nn">.algorithmcomponents</span> <span class="kn">import</span> <span class="n">factorized_jacobian_expressions</span>
<span class="kn">from</span> <span class="nn">.algorithmcomponents</span> <span class="kn">import</span> <span class="n">forward_backward_subst_expressions</span>
<span class="kn">from</span> <span class="nn">.algorithmcomponents</span> <span class="kn">import</span> <span class="n">jacobian_expressions</span>
<span class="kn">from</span> <span class="nn">.algorithmcomponents</span> <span class="kn">import</span> <span class="n">linearized_derivatives</span>
<span class="kn">from</span> <span class="nn">.algorithmcomponents</span> <span class="kn">import</span> <span class="n">monitored_expressions</span>
<span class="kn">from</span> <span class="nn">.algorithmcomponents</span> <span class="kn">import</span> <span class="n">rhs_expressions</span>
<span class="kn">from</span> <span class="nn">.codecomponent</span> <span class="kn">import</span> <span class="n">CodeComponent</span>
<span class="kn">from</span> <span class="nn">.solvercomponents</span> <span class="kn">import</span> <span class="o">*</span>  <span class="c1"># noqa: F403, F401</span>
<span class="kn">from</span> <span class="nn">.solvercomponents</span> <span class="kn">import</span> <span class="n">get_solver_fn</span>

<span class="c1"># System imports</span>
<span class="c1"># Gotran imports</span>
<span class="c1"># Model parameters imports</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;PythonCodeGenerator&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CCodeGenerator&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CppCodeGenerator&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MatlabCodeGenerator&quot;</span><span class="p">,</span>
    <span class="s2">&quot;class_name&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CUDACodeGenerator&quot;</span><span class="p">,</span>
    <span class="s2">&quot;JuliaCodeGenerator&quot;</span><span class="p">,</span>
<span class="p">]</span>


<div class="viewcode-block" id="class_name"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.class_name">[docs]</a><span class="k">def</span> <span class="nf">class_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">check_arg</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">name</span>
        <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span>
        <span class="k">else</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="p">)</span></div>


<span class="k">class</span> <span class="nc">BaseCodeGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for all code generators</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Class attributes</span>
    <span class="n">language</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
    <span class="n">line_ending</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">closure_start</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">closure_end</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">line_cont</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span>
    <span class="n">index</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]&quot;</span>
    <span class="n">indent</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">indent_str</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
    <span class="n">max_line_length</span> <span class="o">=</span> <span class="mi">79</span>
    <span class="n">to_code</span> <span class="o">=</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="kc">None</span>
    <span class="n">float_types</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">single</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="n">double</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">params</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_parameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">float_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Return the float type&quot;</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">float_types</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">float_precision</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">default_parameters</span><span class="p">():</span>
        <span class="c1"># Start out with a copy of the global parameters</span>
        <span class="k">return</span> <span class="n">parameters</span><span class="o">.</span><span class="n">generation</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">states_enum_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> does not implement enum based indexing&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">parameters_enum_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> does not implement enum based indexing&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">state_names_list_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> has no implementation of state names list&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">parameter_names_list_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> has no implementation of parameter names list&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">code_dict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ode</span><span class="p">,</span>
        <span class="n">monitored</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">include_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">include_index_map</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a dict of code snippets</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        ode : gotran.ODE</span>
<span class="sd">            The ODE for which code will be generated</span>
<span class="sd">        monitored : list</span>
<span class="sd">            A list of name of monitored intermediates for which evaluation</span>
<span class="sd">            code will be generated.</span>
<span class="sd">        include_init : bool</span>
<span class="sd">            If True, code for initializing the states and parameters will</span>
<span class="sd">            be generated.</span>
<span class="sd">        include_index_map : bool</span>
<span class="sd">            If True, code for mapping a str to a index for the corresponding,</span>
<span class="sd">            state, parameters or monitored will be generated.</span>
<span class="sd">        indent : int</span>
<span class="sd">            The indentation level for the generated code</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">monitored</span> <span class="o">=</span> <span class="n">monitored</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">check_arg</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">ODE</span><span class="p">)</span>
        <span class="n">check_kwarg</span><span class="p">(</span><span class="n">monitored</span><span class="p">,</span> <span class="s2">&quot;monitored&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">itemtypes</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">functions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">functions</span>

        <span class="n">code</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

        <span class="c1"># If generate enum for states and parameters</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">][</span><span class="s2">&quot;use_enum&quot;</span><span class="p">]:</span>
            <span class="c1"># Ensure that this does not break for languages without enums</span>
            <span class="c1"># TODO: Do this in a cleaner way than catching an exception</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">code</span><span class="p">[</span><span class="s2">&quot;states_enum&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">states_enum_code</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="p">)</span>
                <span class="n">code</span><span class="p">[</span><span class="s2">&quot;parameters_enum&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters_enum_code</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">monitored</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">code</span><span class="p">[</span><span class="s2">&quot;monitor_enum&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitored_enum_code</span><span class="p">(</span><span class="n">monitored</span><span class="p">,</span> <span class="n">indent</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_monitored_index_to_name</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">i</span><span class="p">:</span> <span class="n">m</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">monitored</span><span class="p">)</span>
                    <span class="p">}</span>
            <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">lists</span><span class="o">.</span><span class="n">state_names</span><span class="o">.</span><span class="n">generate</span><span class="p">:</span>
            <span class="n">code</span><span class="p">[</span><span class="s2">&quot;state_names_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_names_list_code</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">lists</span><span class="o">.</span><span class="n">parameter_names</span><span class="o">.</span><span class="n">generate</span><span class="p">:</span>
            <span class="n">code</span><span class="p">[</span><span class="s2">&quot;parameter_names_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_names_list_code</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="p">)</span>

        <span class="c1"># If generate init code</span>
        <span class="k">if</span> <span class="n">include_init</span><span class="p">:</span>
            <span class="n">code</span><span class="p">[</span><span class="s2">&quot;init_states&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_states_code</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="p">)</span>
            <span class="n">code</span><span class="p">[</span><span class="s2">&quot;init_parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_parameters_code</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="p">)</span>

        <span class="c1"># If generate index map code</span>
        <span class="k">if</span> <span class="n">include_index_map</span><span class="p">:</span>
            <span class="n">code</span><span class="p">[</span><span class="s2">&quot;state_indices&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_name_to_index_code</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="p">)</span>
            <span class="n">code</span><span class="p">[</span><span class="s2">&quot;parameter_indices&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_name_to_index_code</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="p">)</span>

        <span class="n">comps</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Code for the right hand side evaluation?</span>
        <span class="k">if</span> <span class="n">functions</span><span class="o">.</span><span class="n">rhs</span><span class="o">.</span><span class="n">generate</span><span class="p">:</span>
            <span class="n">comps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">rhs_expressions</span><span class="p">(</span>
                    <span class="n">ode</span><span class="p">,</span>
                    <span class="n">function_name</span><span class="o">=</span><span class="n">functions</span><span class="o">.</span><span class="n">rhs</span><span class="o">.</span><span class="n">function_name</span><span class="p">,</span>
                    <span class="n">result_name</span><span class="o">=</span><span class="n">functions</span><span class="o">.</span><span class="n">rhs</span><span class="o">.</span><span class="n">result_name</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># Code for any monitored intermediates</span>
        <span class="k">if</span> <span class="n">monitored</span> <span class="ow">and</span> <span class="n">functions</span><span class="o">.</span><span class="n">monitored</span><span class="o">.</span><span class="n">generate</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">include_index_map</span><span class="p">:</span>
                <span class="n">code</span><span class="p">[</span><span class="s2">&quot;monitor_indices&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_name_to_index_code</span><span class="p">(</span>
                    <span class="n">ode</span><span class="p">,</span>
                    <span class="n">monitored</span><span class="p">,</span>
                    <span class="n">indent</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">comps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">monitored_expressions</span><span class="p">(</span>
                    <span class="n">ode</span><span class="p">,</span>
                    <span class="n">monitored</span><span class="p">,</span>
                    <span class="n">function_name</span><span class="o">=</span><span class="n">functions</span><span class="o">.</span><span class="n">monitored</span><span class="o">.</span><span class="n">function_name</span><span class="p">,</span>
                    <span class="n">result_name</span><span class="o">=</span><span class="n">functions</span><span class="o">.</span><span class="n">monitored</span><span class="o">.</span><span class="n">result_name</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># Code for generation of the jacobian of the right hand side</span>
        <span class="n">jac</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">lu_fact</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">functions</span><span class="o">.</span><span class="n">jacobian</span><span class="o">.</span><span class="n">generate</span><span class="p">:</span>
            <span class="n">jac</span> <span class="o">=</span> <span class="n">jacobian_expressions</span><span class="p">(</span>
                <span class="n">ode</span><span class="p">,</span>
                <span class="n">function_name</span><span class="o">=</span><span class="n">functions</span><span class="o">.</span><span class="n">jacobian</span><span class="o">.</span><span class="n">function_name</span><span class="p">,</span>
                <span class="n">result_name</span><span class="o">=</span><span class="n">functions</span><span class="o">.</span><span class="n">jacobian</span><span class="o">.</span><span class="n">result_name</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">comps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jac</span><span class="p">)</span>

        <span class="c1"># Code for the symbolic factorization of the jacobian</span>
        <span class="k">if</span> <span class="n">functions</span><span class="o">.</span><span class="n">lu_factorization</span><span class="o">.</span><span class="n">generate</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">jac</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">jac</span> <span class="o">=</span> <span class="n">jacobian_expressions</span><span class="p">(</span>
                    <span class="n">ode</span><span class="p">,</span>
                    <span class="n">function_name</span><span class="o">=</span><span class="n">functions</span><span class="o">.</span><span class="n">jacobian</span><span class="o">.</span><span class="n">function_name</span><span class="p">,</span>
                    <span class="n">result_name</span><span class="o">=</span><span class="n">functions</span><span class="o">.</span><span class="n">jacobian</span><span class="o">.</span><span class="n">result_name</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">lu_fact</span> <span class="o">=</span> <span class="n">factorized_jacobian_expressions</span><span class="p">(</span>
                <span class="n">jac</span><span class="p">,</span>
                <span class="n">function_name</span><span class="o">=</span><span class="n">functions</span><span class="o">.</span><span class="n">lu_factorization</span><span class="o">.</span><span class="n">function_name</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">comps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lu_fact</span><span class="p">)</span>

        <span class="c1"># Code for the forward backward substituion for a factorized jacobian</span>
        <span class="k">if</span> <span class="n">functions</span><span class="o">.</span><span class="n">forward_backward_subst</span><span class="o">.</span><span class="n">generate</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">jac</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">jac</span> <span class="o">=</span> <span class="n">jacobian_expressions</span><span class="p">(</span>
                    <span class="n">ode</span><span class="p">,</span>
                    <span class="n">function_name</span><span class="o">=</span><span class="n">functions</span><span class="o">.</span><span class="n">jacobian</span><span class="o">.</span><span class="n">function_name</span><span class="p">,</span>
                    <span class="n">result_name</span><span class="o">=</span><span class="n">functions</span><span class="o">.</span><span class="n">jacobian</span><span class="o">.</span><span class="n">result_name</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">lu_fact</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

                <span class="n">lu_fact</span> <span class="o">=</span> <span class="n">factorized_jacobian_expressions</span><span class="p">(</span>
                    <span class="n">jac</span><span class="p">,</span>
                    <span class="n">function_name</span><span class="o">=</span><span class="n">functions</span><span class="o">.</span><span class="n">lu_factorization</span><span class="o">.</span><span class="n">function_name</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">fb_subs_param</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">forward_backward_subst</span>
            <span class="n">fb_subst</span> <span class="o">=</span> <span class="n">forward_backward_subst_expressions</span><span class="p">(</span>
                <span class="n">lu_fact</span><span class="p">,</span>
                <span class="n">function_name</span><span class="o">=</span><span class="n">fb_subs_param</span><span class="o">.</span><span class="n">function_name</span><span class="p">,</span>
                <span class="n">result_name</span><span class="o">=</span><span class="n">fb_subs_param</span><span class="o">.</span><span class="n">result_name</span><span class="p">,</span>
                <span class="n">residual_name</span><span class="o">=</span><span class="n">fb_subs_param</span><span class="o">.</span><span class="n">residual_name</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">comps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fb_subst</span><span class="p">)</span>

        <span class="c1"># Code for generation of linearized derivatives</span>
        <span class="k">if</span> <span class="n">functions</span><span class="o">.</span><span class="n">linearized_rhs_evaluation</span><span class="o">.</span><span class="n">generate</span><span class="p">:</span>
            <span class="n">comps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">linearized_derivatives</span><span class="p">(</span>
                    <span class="n">ode</span><span class="p">,</span>
                    <span class="n">function_name</span><span class="o">=</span><span class="n">functions</span><span class="o">.</span><span class="n">linearized_rhs_evaluation</span><span class="o">.</span><span class="n">function_name</span><span class="p">,</span>
                    <span class="n">result_names</span><span class="o">=</span><span class="n">functions</span><span class="o">.</span><span class="n">linearized_rhs_evaluation</span><span class="o">.</span><span class="n">result_names</span><span class="p">,</span>
                    <span class="n">only_linear</span><span class="o">=</span><span class="n">functions</span><span class="o">.</span><span class="n">linearized_rhs_evaluation</span><span class="o">.</span><span class="n">only_linear</span><span class="p">,</span>
                    <span class="n">include_rhs</span><span class="o">=</span><span class="n">functions</span><span class="o">.</span><span class="n">linearized_rhs_evaluation</span><span class="o">.</span><span class="n">include_rhs</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># Add code for solvers</span>
        <span class="k">for</span> <span class="n">solver</span><span class="p">,</span> <span class="n">solver_params</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">solvers</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">solver_params</span><span class="o">.</span><span class="n">generate</span><span class="p">:</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="n">solver_params</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">to_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;generate&quot;</span><span class="p">)</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span>
                <span class="n">comps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">solver</span> <span class="o">+</span> <span class="s2">&quot;_solver&quot;</span><span class="p">)(</span><span class="n">ode</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

        <span class="c1"># Create code snippest of all</span>
        <span class="n">code</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">function_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_code</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comps</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">functions</span><span class="o">.</span><span class="n">componentwise_rhs_evaluation</span><span class="o">.</span><span class="n">generate</span><span class="p">:</span>
            <span class="n">snippet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">componentwise_code</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">snippet</span><span class="p">:</span>
                <span class="n">code</span><span class="p">[</span><span class="n">functions</span><span class="o">.</span><span class="n">componentwise_rhs_evaluation</span><span class="o">.</span><span class="n">function_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">snippet</span>

        <span class="k">if</span> <span class="n">ode</span><span class="o">.</span><span class="n">is_dae</span><span class="p">:</span>
            <span class="n">mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_matrix</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mass</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">code</span><span class="p">[</span><span class="s2">&quot;mass_matrix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mass</span>

        <span class="k">return</span> <span class="n">code</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">indent_and_split_lines</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">code_lines</span><span class="p">,</span>
        <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">ret_lines</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">no_line_ending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Combine a set of lines into a single string</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">_re_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.*&quot;([\w\s]+)&quot;.*&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_is_number</span><span class="p">(</span><span class="n">num_str</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            A hack to check wether a str is a number</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">num_str</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="n">check_kwarg</span><span class="p">(</span><span class="n">indent</span><span class="p">,</span> <span class="s2">&quot;indent&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ret_lines</span> <span class="o">=</span> <span class="n">ret_lines</span> <span class="ow">or</span> <span class="p">[]</span>

        <span class="c1"># Walk through the code_lines</span>
        <span class="k">for</span> <span class="n">line_ind</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">code_lines</span><span class="p">):</span>

            <span class="c1"># If another closure is encountered</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>

                <span class="c1"># Add start closure sign if any</span>
                <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">closure_start</span><span class="p">:</span>
                    <span class="n">ret_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="bp">cls</span><span class="o">.</span><span class="n">indent</span> <span class="o">*</span> <span class="n">indent</span> <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">indent_str</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">closure_start</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="n">ret_lines</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span>
                    <span class="n">line</span><span class="p">,</span>
                    <span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">ret_lines</span><span class="p">,</span>
                    <span class="n">no_line_ending</span><span class="o">=</span><span class="n">no_line_ending</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Add closure if any</span>
                <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">closure_end</span><span class="p">:</span>
                    <span class="n">ret_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="bp">cls</span><span class="o">.</span><span class="n">indent</span> <span class="o">*</span> <span class="n">indent</span> <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">indent_str</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">closure_end</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">line_ending</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">no_line_ending</span> <span class="k">else</span> <span class="bp">cls</span><span class="o">.</span><span class="n">line_ending</span>

            <span class="c1"># Do not use line endings the line before and after a closure</span>
            <span class="k">if</span> <span class="n">line_ind</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">code_lines</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">code_lines</span><span class="p">[</span><span class="n">line_ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">line_ending</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="c1"># Check if we parse a comment line</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">comment</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">cls</span><span class="o">.</span><span class="n">comment</span> <span class="o">==</span> <span class="n">line</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">comment</span><span class="p">)]:</span>
                <span class="n">is_comment</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">line_ending</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">is_comment</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Empty line</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">ret_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Check for long lines</span>
            <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">indent</span> <span class="o">*</span> <span class="n">indent</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">line_ending</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">cls</span><span class="o">.</span><span class="n">max_line_length</span><span class="p">:</span>

                <span class="c1"># Divide along white spaces</span>
                <span class="n">splitted_line</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span>

                <span class="c1"># If no split</span>
                <span class="k">if</span> <span class="n">splitted_line</span> <span class="o">==</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">ret_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">indent</span> <span class="o">*</span> <span class="n">indent</span> <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">indent_str</span><span class="si">}{</span><span class="n">line</span><span class="si">}{</span><span class="n">line_ending</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">first_line</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">inside_str</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">while</span> <span class="n">splitted_line</span><span class="p">:</span>
                    <span class="n">line_stump</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">indent_length</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">indent</span> <span class="o">*</span> <span class="p">(</span>
                        <span class="n">indent</span> <span class="k">if</span> <span class="n">first_line</span> <span class="ow">or</span> <span class="n">is_comment</span> <span class="k">else</span> <span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="p">)</span>
                    <span class="n">line_length</span> <span class="o">=</span> <span class="n">indent_length</span>

                    <span class="c1"># Check if we are not exeeding the max_line_length</span>
                    <span class="c1"># FIXME: Line continuation symbol is not included in</span>
                    <span class="c1"># FIXME: linelength</span>
                    <span class="k">while</span> <span class="n">splitted_line</span> <span class="ow">and</span> <span class="p">(</span>
                        <span class="p">(</span>
                            <span class="p">(</span><span class="n">line_length</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">splitted_line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">inside_str</span><span class="p">)</span>
                            <span class="o">&lt;</span> <span class="bp">cls</span><span class="o">.</span><span class="n">max_line_length</span>
                        <span class="p">)</span>
                        <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="n">line_stump</span> <span class="ow">and</span> <span class="n">line_stump</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="ow">or</span> <span class="n">_is_number</span><span class="p">(</span><span class="n">line_stump</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="p">):</span>
                        <span class="n">line_stump</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">splitted_line</span><span class="o">.</span><span class="n">popleft</span><span class="p">())</span>

                        <span class="c1"># Add a \&quot; char to first stub if inside str</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line_stump</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">inside_str</span><span class="p">:</span>
                            <span class="n">line_stump</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">line_stump</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                        <span class="c1"># Check if we get inside or leave a str</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_comment</span> <span class="ow">and</span> <span class="p">(</span>
                            <span class="s1">&#39;&quot;&#39;</span> <span class="ow">in</span> <span class="n">line_stump</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
                                <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;&#39;</span> <span class="ow">in</span> <span class="n">line_stump</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                <span class="ow">or</span> <span class="s1">&#39;&quot;&quot;&quot;&#39;</span> <span class="ow">in</span> <span class="n">line_stump</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">_re_str</span><span class="p">,</span> <span class="n">line_stump</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                            <span class="p">)</span>
                        <span class="p">):</span>
                            <span class="n">inside_str</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">inside_str</span>

                        <span class="c1"># Check line length</span>
                        <span class="n">line_length</span> <span class="o">+=</span> <span class="p">(</span>
                            <span class="nb">len</span><span class="p">(</span><span class="n">line_stump</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                            <span class="o">+</span> <span class="mi">1</span>
                            <span class="o">+</span> <span class="p">(</span><span class="n">is_comment</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">first_line</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">comment</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="p">)</span>

                    <span class="c1"># If we are inside a str and at the end of line add</span>
                    <span class="k">if</span> <span class="n">inside_str</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_comment</span><span class="p">:</span>
                        <span class="n">line_stump</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">line_stump</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>

                    <span class="c1"># Join line stump and add indentation</span>
                    <span class="n">ret_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">indent_length</span> <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">indent_str</span>
                        <span class="o">+</span> <span class="p">(</span><span class="n">is_comment</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">first_line</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">comment</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line_stump</span><span class="p">),</span>
                    <span class="p">)</span>

                    <span class="c1"># If it is the last line stump add line ending otherwise</span>
                    <span class="c1"># line continuation sign</span>
                    <span class="n">ret_lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret_lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="ow">not</span> <span class="n">is_comment</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                        <span class="bp">cls</span><span class="o">.</span><span class="n">line_cont</span> <span class="k">if</span> <span class="n">splitted_line</span> <span class="k">else</span> <span class="n">line_ending</span>
                    <span class="p">)</span>

                    <span class="n">first_line</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">indent</span> <span class="o">*</span> <span class="n">indent</span> <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">indent_str</span><span class="si">}{</span><span class="n">line</span><span class="si">}{</span><span class="n">line_ending</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">ret_lines</span>


<div class="viewcode-block" id="PythonCodeGenerator"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.PythonCodeGenerator">[docs]</a><span class="k">class</span> <span class="nc">PythonCodeGenerator</span><span class="p">(</span><span class="n">BaseCodeGenerator</span><span class="p">):</span>

    <span class="c1"># Class attributes</span>
    <span class="n">language</span> <span class="o">=</span> <span class="s2">&quot;python&quot;</span>
    <span class="n">to_code</span> <span class="o">=</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">pythoncode</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">)</span>
    <span class="n">float_types</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">single</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="n">double</span><span class="o">=</span><span class="s2">&quot;float_&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ns</span><span class="o">=</span><span class="s2">&quot;math&quot;</span><span class="p">,</span> <span class="n">import_inside_functions</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="n">check_arg</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">ns</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;math&quot;</span><span class="p">,</span> <span class="s2">&quot;np&quot;</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;ufl&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ns</span> <span class="o">=</span> <span class="n">ns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_inside_functions</span> <span class="o">=</span> <span class="n">import_inside_functions</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PythonCodeGenerator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

<div class="viewcode-block" id="PythonCodeGenerator.args"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.PythonCodeGenerator.args">[docs]</a>    <span class="k">def</span> <span class="nf">args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build argument str</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span>
        <span class="n">default_arguments</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">params</span><span class="o">.</span><span class="n">default_arguments</span> <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">use_default_arguments</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>

        <span class="n">additional_arguments</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">additional_arguments</span><span class="p">[:]</span>

        <span class="n">skip_result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ret_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">default_arguments</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="o">==</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
                    <span class="n">skip_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span><span class="p">)</span>
                <span class="n">ret_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">arg</span> <span class="o">==</span> <span class="s2">&quot;t&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
                    <span class="n">skip_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">ret_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;dt&quot;</span> <span class="ow">in</span> <span class="n">additional_arguments</span><span class="p">:</span>
                    <span class="n">additional_arguments</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;dt&quot;</span><span class="p">)</span>
                    <span class="n">ret_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">arg</span> <span class="o">==</span> <span class="s2">&quot;p&quot;</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">representation</span> <span class="o">!=</span> <span class="s2">&quot;numerals&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">array_name</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
                    <span class="n">skip_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">array_name</span><span class="p">)</span>
                <span class="n">ret_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">array_name</span><span class="p">)</span>

        <span class="n">ret_args</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">additional_arguments</span><span class="p">)</span>

        <span class="c1"># Arguments with default (None) values</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">in_signature</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">representation</span> <span class="o">!=</span> <span class="s2">&quot;named&quot;</span><span class="p">:</span>
            <span class="n">ret_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">array_name</span><span class="si">}</span><span class="s2">=None&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">result_name</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skip_result</span><span class="p">:</span>
                <span class="n">ret_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result_name</span><span class="si">}</span><span class="s2">=None&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ret_args</span><span class="p">)</span></div>

<div class="viewcode-block" id="PythonCodeGenerator.decorators"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.PythonCodeGenerator.decorators">[docs]</a>    <span class="k">def</span> <span class="nf">decorators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># FIXME: Make this extendable with mode decorators or make it possible</span>
        <span class="c1"># FIXME: to use other standard decorators like classmethod</span>
        <span class="k">return</span> <span class="s2">&quot;@staticmethod&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">class_code</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span></div>

<div class="viewcode-block" id="PythonCodeGenerator.wrap_body_with_function_prototype"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.PythonCodeGenerator.wrap_body_with_function_prototype">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">wrap_body_with_function_prototype</span><span class="p">(</span>
        <span class="n">body_lines</span><span class="p">,</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">args</span><span class="p">,</span>
        <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">decorators</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrap a passed body of lines with a function prototype</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_arg</span><span class="p">(</span><span class="n">body_lines</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="n">check_arg</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">check_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">check_arg</span><span class="p">(</span><span class="n">comment</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span>
        <span class="n">check_arg</span><span class="p">(</span><span class="n">decorators</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span>

        <span class="n">prototype</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">decorators</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">decorators</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">prototype</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">decorators</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prototype</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">decorators</span><span class="p">)</span>

        <span class="n">prototype</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;def </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Wrap comment if any</span>
        <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
            <span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&quot;&quot;&quot;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comment</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">body</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
            <span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&quot;&quot;&quot;&#39;</span><span class="p">)</span>

        <span class="c1"># Extend the body with body lines</span>
        <span class="n">body</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">body_lines</span><span class="p">)</span>

        <span class="c1"># Append body to prototyp</span>
        <span class="n">prototype</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">prototype</span></div>

    <span class="k">def</span> <span class="nf">_init_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp</span><span class="p">):</span>

        <span class="n">check_arg</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">CodeComponent</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span>

        <span class="n">default_arguments</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">params</span><span class="o">.</span><span class="n">default_arguments</span> <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">use_default_arguments</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Check if comp defines used_states if not use the root components</span>
        <span class="c1"># full_states attribute</span>
        <span class="c1"># FIXME: No need for full_states here...</span>
        <span class="n">used_states</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">comp</span><span class="o">.</span><span class="n">used_states</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="s2">&quot;used_states&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">full_states</span>
        <span class="p">)</span>

        <span class="n">used_parameters</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">comp</span><span class="o">.</span><span class="n">used_parameters</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="s2">&quot;used_parameters&quot;</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">parameters</span>
        <span class="p">)</span>

        <span class="n">num_states</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">num_full_states</span>
        <span class="n">num_parameters</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">num_parameters</span>

        <span class="c1"># Start building body</span>
        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s2">&quot;s&quot;</span> <span class="ow">in</span> <span class="n">default_arguments</span> <span class="ow">and</span> <span class="n">used_states</span><span class="p">:</span>

            <span class="n">states_name</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# Assign states&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;assert(len(</span><span class="si">{</span><span class="n">states_name</span><span class="si">}</span><span class="s2">) == </span><span class="si">{</span><span class="n">num_states</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="c1"># Generate state assign code</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">representation</span> <span class="o">==</span> <span class="s2">&quot;named&quot;</span><span class="p">:</span>

                <span class="c1"># If all states are used</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">used_states</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">full_states</span><span class="p">):</span>
                    <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="n">state</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">full_states</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="o">+</span> <span class="s2">&quot; = &quot;</span>
                        <span class="o">+</span> <span class="n">states_name</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="c1"># If only a limited number of states are used</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">states_name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">]&quot;</span>
                            <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">full_states</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">used_states</span>
                        <span class="p">),</span>
                    <span class="p">)</span>

        <span class="c1"># Add parameters code if not numerals</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="s2">&quot;p&quot;</span> <span class="ow">in</span> <span class="n">default_arguments</span>
            <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">representation</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;named&quot;</span><span class="p">,</span> <span class="s2">&quot;array&quot;</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">used_parameters</span>
        <span class="p">):</span>

            <span class="n">parameters_name</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">array_name</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# Assign parameters&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;assert(len(</span><span class="si">{</span><span class="n">parameters_name</span><span class="si">}</span><span class="s2">) == </span><span class="si">{</span><span class="n">num_parameters</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="c1"># Generate parameters assign code</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">representation</span> <span class="o">==</span> <span class="s2">&quot;named&quot;</span><span class="p">:</span>

                <span class="c1"># If all parameters are used</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">used_parameters</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">parameters</span><span class="p">):</span>
                    <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">used_parameters</span><span class="p">))</span>
                        <span class="o">+</span> <span class="s2">&quot; = &quot;</span>
                        <span class="o">+</span> <span class="n">parameters_name</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="c1"># If only a limited number of states are used</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">parameters_name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">]&quot;</span>
                            <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">used_parameters</span>
                        <span class="p">),</span>
                    <span class="p">)</span>

        <span class="c1"># If using an array for the body variables</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">representation</span> <span class="o">!=</span> <span class="s2">&quot;named&quot;</span>
            <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">array_name</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">shapes</span>
        <span class="p">):</span>

            <span class="n">body_name</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">array_name</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# Body array </span><span class="si">{</span><span class="n">body_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># If passing the body argument to the method</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">in_signature</span><span class="p">:</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;if </span><span class="si">{</span><span class="n">body_name</span><span class="si">}</span><span class="s2"> is None:&quot;</span><span class="p">)</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> = np.zeros(</span><span class="si">{1}</span><span class="s2">, dtype=np.</span><span class="si">{2}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">body_name</span><span class="p">,</span>
                            <span class="n">comp</span><span class="o">.</span><span class="n">shapes</span><span class="p">[</span><span class="n">body_name</span><span class="p">],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">],</span>
                <span class="p">)</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;else:&quot;</span><span class="p">)</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="s2">&quot;assert isinstance(</span><span class="si">{0}</span><span class="s2">, np.ndarray) and &quot;</span>
                        <span class="s2">&quot;</span><span class="si">{1}</span><span class="s2">.shape==</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">body_name</span><span class="p">,</span>
                            <span class="n">body_name</span><span class="p">,</span>
                            <span class="n">comp</span><span class="o">.</span><span class="n">shapes</span><span class="p">[</span><span class="n">body_name</span><span class="p">],</span>
                        <span class="p">),</span>
                    <span class="p">],</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> = np.zeros(</span><span class="si">{1}</span><span class="s2">, dtype=np.</span><span class="si">{2}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">body_name</span><span class="p">,</span>
                        <span class="n">comp</span><span class="o">.</span><span class="n">shapes</span><span class="p">[</span><span class="n">body_name</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">)</span>

        <span class="c1"># If initelizing results</span>
        <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>

            <span class="n">results</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">results</span><span class="p">[:]</span>

            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">array_name</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">array_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# Init return args&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">result_name</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">shapes</span><span class="p">[</span><span class="n">result_name</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">flatten</span><span class="p">:</span>
                        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="mi">1</span><span class="p">),)</span>

                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;if </span><span class="si">{</span><span class="n">result_name</span><span class="si">}</span><span class="s2"> is None:&quot;</span><span class="p">)</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result_name</span><span class="si">}</span><span class="s2"> = np.zeros(</span><span class="si">{</span><span class="n">shape</span><span class="si">}</span><span class="s2">, dtype=np.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;else:&quot;</span><span class="p">)</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="s2">&quot;assert isinstance(</span><span class="si">{0}</span><span class="s2">, np.ndarray) and &quot;</span>
                        <span class="s2">&quot;</span><span class="si">{1}</span><span class="s2">.shape == </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result_name</span><span class="p">,</span> <span class="n">result_name</span><span class="p">,</span> <span class="n">shape</span><span class="p">),</span>
                    <span class="p">],</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">body_lines</span>

<div class="viewcode-block" id="PythonCodeGenerator.function_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.PythonCodeGenerator.function_code">[docs]</a>    <span class="k">def</span> <span class="nf">function_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">include_signature</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate code for a single function given by a CodeComponent</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">check_arg</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">CodeComponent</span><span class="p">)</span>
        <span class="n">check_kwarg</span><span class="p">(</span><span class="n">indent</span><span class="p">,</span> <span class="s2">&quot;indent&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>

        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_inside_functions</span><span class="p">:</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;# Imports&quot;</span><span class="p">,</span> <span class="s2">&quot;import numpy as np&quot;</span><span class="p">])</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ns</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ns</span> <span class="o">!=</span> <span class="s2">&quot;np&quot;</span><span class="p">:</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;import </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">body_lines</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_arguments</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>

        <span class="c1"># Iterate over any body needed to define the dy</span>
        <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">body_expressions</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Comment</span><span class="p">):</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_code</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">expr</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# Return results&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;return </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">result_name</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">shapes</span><span class="p">[</span><span class="n">result_name</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">1</span>
                        <span class="ow">and</span> <span class="n">comp</span><span class="o">.</span><span class="n">shapes</span><span class="p">[</span><span class="n">result_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span>
                        <span class="k">else</span> <span class="n">result_name</span> <span class="o">+</span> <span class="s2">&quot;[0]&quot;</span>
                        <span class="k">for</span> <span class="n">result_name</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">results</span>
                    <span class="p">),</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">include_signature</span><span class="p">:</span>

            <span class="c1"># Add function prototype</span>
            <span class="n">body_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
                <span class="n">body_lines</span><span class="p">,</span>
                <span class="n">comp</span><span class="o">.</span><span class="n">function_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">(</span><span class="n">comp</span><span class="p">),</span>
                <span class="n">comp</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">decorators</span><span class="p">(),</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">body_lines</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span></div>

<div class="viewcode-block" id="PythonCodeGenerator.state_names_list_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.PythonCodeGenerator.state_names_list_code">[docs]</a>    <span class="k">def</span> <span class="nf">state_names_list_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

        <span class="n">state_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ode</span><span class="o">.</span><span class="n">full_states</span><span class="p">]</span>
        <span class="n">state_names_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">lists</span><span class="o">.</span><span class="n">state_names</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">state_names</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">state_names_str</span><span class="p">]</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">body_lines</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span></div>

<div class="viewcode-block" id="PythonCodeGenerator.parameter_names_list_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.PythonCodeGenerator.parameter_names_list_code">[docs]</a>    <span class="k">def</span> <span class="nf">parameter_names_list_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">parameter_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ode</span><span class="o">.</span><span class="n">parameters</span><span class="p">]</span>
        <span class="n">parameter_names_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">lists</span><span class="o">.</span><span class="n">parameter_names</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">repr</span><span class="p">(</span><span class="n">parameter_names</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">parameter_names_str</span><span class="p">]</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">body_lines</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span></div>

<div class="viewcode-block" id="PythonCodeGenerator.init_states_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.PythonCodeGenerator.init_states_code">[docs]</a>    <span class="k">def</span> <span class="nf">init_states_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">perform_range_check</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate code for setting initial condition</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">check_arg</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">ODE</span><span class="p">)</span>

        <span class="c1"># Get all full states</span>
        <span class="n">states</span> <span class="o">=</span> <span class="n">ode</span><span class="o">.</span><span class="n">full_states</span>

        <span class="c1"># Start building body</span>
        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_inside_functions</span><span class="p">:</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;# Imports&quot;</span><span class="p">,</span> <span class="s2">&quot;import numpy as np&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">perform_range_check</span><span class="p">:</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;from modelparameters.utils import Range&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">body_lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">body_lines</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;# Init values&quot;</span><span class="p">]</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;# </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">=</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">init</span><span class="p">)</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;init_values = np.array([</span><span class="si">{0}</span><span class="s2">], dtype=np.</span><span class="si">{1}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">init</span><span class="p">)</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# State indices and limit checker&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">perform_range_check</span><span class="p">:</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;state_ind = dict([</span><span class="si">{0}</span><span class="s2">])&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="s1">&#39;(&quot;</span><span class="si">{0}</span><span class="s1">&quot;,(</span><span class="si">{1}</span><span class="s1">, </span><span class="si">{2}</span><span class="s1">))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">state</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">i</span><span class="p">,</span>
                            <span class="nb">repr</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">_range</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
                    <span class="p">),</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;state_ind = dict([</span><span class="si">{0}</span><span class="s2">])&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="s1">&#39;(&quot;</span><span class="si">{0}</span><span class="s1">&quot;, </span><span class="si">{1}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
                    <span class="p">),</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;for state_name, value in values.items():&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">perform_range_check</span><span class="p">:</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;if state_name not in state_ind:&quot;</span><span class="p">,</span>
                    <span class="p">[</span><span class="s1">&#39;raise ValueError(&quot;</span><span class="si">{0}</span><span class="s1"> is not a state.&quot;.format(state_name))&#39;</span><span class="p">],</span>
                    <span class="c1"># FIXME: Outcommented because of bug in indent_and_split_lines</span>
                    <span class="c1"># [&quot;raise ValueError(\&quot;{{0}} is not a state in the {0} ODE\&quot;.&quot;\</span>
                    <span class="c1"># &quot;format(state_name))&quot;.format(self.oderepr.name)],</span>
                    <span class="s2">&quot;ind, range = state_ind[state_name]&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;if value not in range:&quot;</span><span class="p">,</span>
                    <span class="p">[</span>
                        <span class="s2">&quot;raise ValueError(</span><span class="se">\&quot;</span><span class="s2">While setting &#39;</span><span class="si">{0}</span><span class="s2">&#39; </span><span class="si">{1}</span><span class="se">\&quot;</span><span class="s2">.format(&quot;</span>
                        <span class="s2">&quot;state_name, range.format_not_in(value)))&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;# Assign value&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;init_values[ind] = value&quot;</span><span class="p">,</span>
                <span class="p">],</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;if state_name not in state_ind:&quot;</span><span class="p">,</span>
                    <span class="p">[</span><span class="s1">&#39;raise ValueError(&quot;</span><span class="si">{0}</span><span class="s1"> is not a state.&quot;.format(state_name))&#39;</span><span class="p">],</span>
                    <span class="s2">&quot;ind = state_ind[state_name]&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;# Assign value&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;init_values[ind] = value&quot;</span><span class="p">,</span>
                <span class="p">],</span>
            <span class="p">)</span>

        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;return init_values&quot;</span><span class="p">)</span>

        <span class="c1"># Add function prototype</span>
        <span class="n">init_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
            <span class="n">body_lines</span><span class="p">,</span>
            <span class="s2">&quot;init_state_values&quot;</span><span class="p">,</span>
            <span class="s2">&quot;**values&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Initialize state values&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">decorators</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">init_function</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span></div>

<div class="viewcode-block" id="PythonCodeGenerator.init_parameters_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.PythonCodeGenerator.init_parameters_code">[docs]</a>    <span class="k">def</span> <span class="nf">init_parameters_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">perform_range_check</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate code for setting parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">check_arg</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">ODE</span><span class="p">)</span>

        <span class="c1"># Get all parameters</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">ode</span><span class="o">.</span><span class="n">parameters</span>

        <span class="c1"># Start building body</span>
        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_inside_functions</span><span class="p">:</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;# Imports&quot;</span><span class="p">,</span> <span class="s2">&quot;import numpy as np&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">perform_range_check</span><span class="p">:</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;from modelparameters.utils import Range&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">body_lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">body_lines</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;# Param values&quot;</span><span class="p">]</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;# </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">=</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">param</span><span class="o">.</span><span class="n">init</span><span class="p">)</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">parameters</span>
                <span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;init_values = np.array([</span><span class="si">{0}</span><span class="s2">], dtype=np.</span><span class="si">{1}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">init</span><span class="p">)</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# Parameter indices and limit checker&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">perform_range_check</span><span class="p">:</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;param_ind = dict([</span><span class="si">{0}</span><span class="s2">])&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="s1">&#39;(&quot;</span><span class="si">{0}</span><span class="s1">&quot;, (</span><span class="si">{1}</span><span class="s1">, </span><span class="si">{2}</span><span class="s1">))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">param</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">i</span><span class="p">,</span>
                            <span class="nb">repr</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">_range</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
                    <span class="p">),</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;param_ind = dict([</span><span class="si">{0}</span><span class="s2">])&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="s1">&#39;(&quot;</span><span class="si">{0}</span><span class="s1">&quot;, </span><span class="si">{1}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
                    <span class="p">),</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;for param_name, value in values.items():&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">perform_range_check</span><span class="p">:</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;if param_name not in param_ind:&quot;</span><span class="p">,</span>
                    <span class="p">[</span><span class="s1">&#39;raise ValueError(&quot;</span><span class="si">{0}</span><span class="s1"> is not a parameter.&quot;.format(param_name))&#39;</span><span class="p">],</span>
                    <span class="c1"># [&quot;raise ValueError(\&quot;{{0}} is not a param in the {0} ODE\&quot;.&quot;\</span>
                    <span class="c1">#  &quot;format(param_name))&quot;.format(self.oderepr.name)],</span>
                    <span class="s2">&quot;ind, range = param_ind[param_name]&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;if value not in range:&quot;</span><span class="p">,</span>
                    <span class="p">[</span>
                        <span class="s2">&quot;raise ValueError(</span><span class="se">\&quot;</span><span class="s2">While setting &#39;</span><span class="si">{0}</span><span class="s2">&#39; </span><span class="si">{1}</span><span class="se">\&quot;</span><span class="s2">.format(&quot;</span>
                        <span class="s2">&quot;param_name, range.format_not_in(value)))&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;# Assign value&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;init_values[ind] = value&quot;</span><span class="p">,</span>
                <span class="p">],</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;if param_name not in param_ind:&quot;</span><span class="p">,</span>
                    <span class="p">[</span><span class="s1">&#39;raise ValueError(&quot;</span><span class="si">{0}</span><span class="s1"> is not a parameter.&quot;.format(param_name))&#39;</span><span class="p">],</span>
                    <span class="s2">&quot;ind = param_ind[param_name]&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;# Assign value&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;init_values[ind] = value&quot;</span><span class="p">,</span>
                <span class="p">],</span>
            <span class="p">)</span>

        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;return init_values&quot;</span><span class="p">)</span>

        <span class="c1"># Add function prototype</span>
        <span class="n">function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
            <span class="n">body_lines</span><span class="p">,</span>
            <span class="s2">&quot;init_parameter_values&quot;</span><span class="p">,</span>
            <span class="s2">&quot;**values&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Initialize parameter values&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">decorators</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span></div>

<div class="viewcode-block" id="PythonCodeGenerator.state_name_to_index_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.PythonCodeGenerator.state_name_to_index_code">[docs]</a>    <span class="k">def</span> <span class="nf">state_name_to_index_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return code for index handling for states</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_arg</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">ODE</span><span class="p">)</span>
        <span class="n">states</span> <span class="o">=</span> <span class="n">ode</span><span class="o">.</span><span class="n">full_states</span>

        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;state_inds = dict([</span><span class="si">{0}</span><span class="s2">])&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="s1">&#39;(&quot;</span><span class="si">{0}</span><span class="s1">&quot;, </span><span class="si">{1}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;indices = []&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;for state in states:&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;if state not in state_inds:&quot;</span><span class="p">,</span>
                <span class="p">[</span><span class="s2">&quot;raise ValueError(</span><span class="se">\&quot;</span><span class="s2">Unknown state: &#39;</span><span class="si">{0}</span><span class="s2">&#39;</span><span class="se">\&quot;</span><span class="s2">.format(state))&quot;</span><span class="p">],</span>
                <span class="s2">&quot;indices.append(state_inds[state])&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;if len(indices)&gt;1:&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;return indices&quot;</span><span class="p">])</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;else:&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;return indices[0]&quot;</span><span class="p">])</span>

        <span class="c1"># Add function prototype</span>
        <span class="n">function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
            <span class="n">body_lines</span><span class="p">,</span>
            <span class="s2">&quot;state_indices&quot;</span><span class="p">,</span>
            <span class="s2">&quot;*states&quot;</span><span class="p">,</span>
            <span class="s2">&quot;State indices&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">decorators</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span></div>

<div class="viewcode-block" id="PythonCodeGenerator.param_name_to_index_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.PythonCodeGenerator.param_name_to_index_code">[docs]</a>    <span class="k">def</span> <span class="nf">param_name_to_index_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return code for index handling for parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">check_arg</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">ODE</span><span class="p">)</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="n">ode</span><span class="o">.</span><span class="n">parameters</span>

        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;param_inds = dict([</span><span class="si">{0}</span><span class="s2">])&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="s1">&#39;(&quot;</span><span class="si">{0}</span><span class="s1">&quot;, </span><span class="si">{1}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;indices = []&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;for param in params:&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;if param not in param_inds:&quot;</span><span class="p">,</span>
                <span class="p">[</span><span class="s2">&quot;raise ValueError(</span><span class="se">\&quot;</span><span class="s2">Unknown param: &#39;</span><span class="si">{0}</span><span class="s2">&#39;</span><span class="se">\&quot;</span><span class="s2">.format(param))&quot;</span><span class="p">],</span>
                <span class="s2">&quot;indices.append(param_inds[param])&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;if len(indices)&gt;1:&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;return indices&quot;</span><span class="p">])</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;else:&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;return indices[0]&quot;</span><span class="p">])</span>

        <span class="c1"># Add function prototype</span>
        <span class="n">function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
            <span class="n">body_lines</span><span class="p">,</span>
            <span class="s2">&quot;parameter_indices&quot;</span><span class="p">,</span>
            <span class="s2">&quot;*params&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Parameter indices&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">decorators</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span></div>

<div class="viewcode-block" id="PythonCodeGenerator.monitor_name_to_index_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.PythonCodeGenerator.monitor_name_to_index_code">[docs]</a>    <span class="k">def</span> <span class="nf">monitor_name_to_index_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">monitored</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return code for index handling for monitored</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_arg</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">ODE</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">expr_str</span> <span class="ow">in</span> <span class="n">monitored</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">ode</span><span class="o">.</span><span class="n">present_ode_objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">expr_str</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Expression</span><span class="p">):</span>
                <span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> is not an intermediate or state expression in &quot;</span>
                    <span class="s2">&quot;the </span><span class="si">{1}</span><span class="s2"> ODE&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">expr_str</span><span class="p">,</span> <span class="n">ode</span><span class="p">),</span>
                <span class="p">)</span>

        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;monitor_inds = dict([</span><span class="si">{0}</span><span class="s2">])&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="s1">&#39;(&quot;</span><span class="si">{0}</span><span class="s1">&quot;, </span><span class="si">{1}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">monitor</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">monitor</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">monitored</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;indices = []&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;for monitor in monitored:&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;if monitor not in monitor_inds:&quot;</span><span class="p">,</span>
                <span class="p">[</span><span class="s2">&quot;raise ValueError(</span><span class="se">\&quot;</span><span class="s2">Unknown monitored: &#39;</span><span class="si">{0}</span><span class="s2">&#39;</span><span class="se">\&quot;</span><span class="s2">.format(monitor))&quot;</span><span class="p">],</span>
                <span class="s2">&quot;indices.append(monitor_inds[monitor])&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;if len(indices)&gt;1:&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;return indices&quot;</span><span class="p">])</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;else:&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;return indices[0]&quot;</span><span class="p">])</span>

        <span class="c1"># Add function prototype</span>
        <span class="n">function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
            <span class="n">body_lines</span><span class="p">,</span>
            <span class="s2">&quot;monitor_indices&quot;</span><span class="p">,</span>
            <span class="s2">&quot;*monitored&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Monitor indices&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">decorators</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span></div>

<div class="viewcode-block" id="PythonCodeGenerator.componentwise_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.PythonCodeGenerator.componentwise_code">[docs]</a>    <span class="k">def</span> <span class="nf">componentwise_code</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ode</span><span class="p">,</span>
        <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">include_signature</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">return_body_lines</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Generation of componentwise_rhs_evaluation code is not &quot;</span>
            <span class="s2">&quot;yet implemented for Python backend.&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="PythonCodeGenerator.mass_matrix"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.PythonCodeGenerator.mass_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">mass_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">check_arg</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">ODE</span><span class="p">)</span>
        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;import numpy as np&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;M = np.eye(</span><span class="si">{</span><span class="n">ode</span><span class="o">.</span><span class="n">num_full_states</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">expr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ode</span><span class="o">.</span><span class="n">state_expressions</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">AlgebraicExpression</span><span class="p">):</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;M[</span><span class="si">{0}</span><span class="s2">,</span><span class="si">{0}</span><span class="s2">] = 0&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span>

        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;return M&quot;</span><span class="p">)</span>

        <span class="n">body_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
            <span class="n">body_lines</span><span class="p">,</span>
            <span class="s2">&quot;mass_matrix&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;The mass matrix of the </span><span class="si">{</span><span class="n">ode</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> ODE&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">body_lines</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span></div>

<div class="viewcode-block" id="PythonCodeGenerator.class_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.PythonCodeGenerator.class_code">[docs]</a>    <span class="k">def</span> <span class="nf">class_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">monitored</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate class code</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Force class code param to be True</span>
        <span class="n">class_code_param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">class_code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">class_code</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">check_arg</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">ODE</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">class_name</span><span class="p">(</span><span class="n">ode</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">code_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code_dict</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">monitored</span><span class="o">=</span><span class="n">monitored</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">class_code</span> <span class="o">=</span> <span class="n">class_code_param</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">class </span><span class="si">{0}</span><span class="s2">:</span>

<span class="si">{1}</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">code_list</span><span class="p">),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="PythonCodeGenerator.module_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.PythonCodeGenerator.module_code">[docs]</a>    <span class="k">def</span> <span class="nf">module_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">monitored</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># Force class code param to be False</span>
        <span class="n">class_code_param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">class_code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">class_code</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">check_arg</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">ODE</span><span class="p">)</span>
        <span class="n">code_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code_dict</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">monitored</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">class_code</span> <span class="o">=</span> <span class="n">class_code_param</span>

        <span class="n">import_lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_inside_functions</span><span class="p">:</span>
            <span class="n">import_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;import numpy as np&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ns</span> <span class="o">!=</span> <span class="s2">&quot;np&quot;</span><span class="p">:</span>
                <span class="n">import_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;import </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">fmt_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;# Gotran generated code for the &quot;</span><span class="si">{model_name}</span><span class="s2">&quot; model</span>
<span class="si">{imports}</span><span class="s2"></span>

<span class="si">{main_body}</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">fmt_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">model_name</span><span class="o">=</span><span class="n">ode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">imports</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">import_lines</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">main_body</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">code_list</span><span class="p">),</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="CCodeGenerator"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.CCodeGenerator">[docs]</a><span class="k">class</span> <span class="nc">CCodeGenerator</span><span class="p">(</span><span class="n">BaseCodeGenerator</span><span class="p">):</span>

    <span class="c1"># Class attributes</span>
    <span class="n">language</span> <span class="o">=</span> <span class="s2">&quot;C&quot;</span>
    <span class="n">line_ending</span> <span class="o">=</span> <span class="s2">&quot;;&quot;</span>
    <span class="n">closure_start</span> <span class="o">=</span> <span class="s2">&quot;{&quot;</span>
    <span class="n">closure_end</span> <span class="o">=</span> <span class="s2">&quot;}&quot;</span>
    <span class="n">line_cont</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;//&quot;</span>
    <span class="n">index</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]&quot;</span>
    <span class="n">indent</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">indent_str</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
    <span class="n">to_code</span> <span class="o">=</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">ccode</span><span class="p">(</span>
        <span class="n">expr</span><span class="p">,</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">float_precision</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">float_types</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">single</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="n">double</span><span class="o">=</span><span class="s2">&quot;double&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="CCodeGenerator.obj_name"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.CCodeGenerator.obj_name">[docs]</a>    <span class="k">def</span> <span class="nf">obj_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">ODEObject</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;I&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span></div>

<div class="viewcode-block" id="CCodeGenerator.args"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.CCodeGenerator.args">[docs]</a>    <span class="k">def</span> <span class="nf">args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp</span><span class="p">):</span>

        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span>
        <span class="n">default_arguments</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">params</span><span class="o">.</span><span class="n">default_arguments</span> <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">use_default_arguments</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>

        <span class="n">additional_arguments</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">additional_arguments</span><span class="p">[:]</span>

        <span class="n">skip_result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ret_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">default_arguments</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="o">==</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
                    <span class="n">skip_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span><span class="p">)</span>
                    <span class="n">ret_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2"> *__restrict </span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ret_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s2">&quot;const </span><span class="si">{0}</span><span class="s2"> *__restrict </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="p">,</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
            <span class="k">elif</span> <span class="n">arg</span> <span class="o">==</span> <span class="s2">&quot;t&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
                    <span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;Cannot have the same name for the time argument as &quot;</span>
                        <span class="s2">&quot;for a result argument.&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="n">ret_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;const </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;dt&quot;</span> <span class="ow">in</span> <span class="n">additional_arguments</span><span class="p">:</span>
                    <span class="n">additional_arguments</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;dt&quot;</span><span class="p">)</span>
                    <span class="n">ret_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;const </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">arg</span> <span class="o">==</span> <span class="s2">&quot;p&quot;</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">representation</span> <span class="o">!=</span> <span class="s2">&quot;numerals&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">array_name</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
                    <span class="n">skip_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">array_name</span><span class="p">)</span>
                    <span class="n">ret_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2"> *__restrict </span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">array_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ret_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s2">&quot;const </span><span class="si">{0}</span><span class="s2"> *__restrict </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="p">,</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">array_name</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">)</span>

                <span class="n">field_parameters</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="s2">&quot;field_parameters&quot;</span><span class="p">]</span>

                <span class="c1"># If empty</span>
                <span class="c1"># FIXME: Get rid of this by introducing a ListParam type in modelparameters</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_parameters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">field_parameters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">field_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span>
                <span class="p">):</span>
                    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">field_array_name</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
                        <span class="n">skip_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">field_array_name</span><span class="p">)</span>
                        <span class="n">ret_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2">* </span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">field_array_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ret_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="s2">&quot;const </span><span class="si">{0}</span><span class="s2">* </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="p">,</span>
                                <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">field_array_name</span><span class="p">,</span>
                            <span class="p">),</span>
                        <span class="p">)</span>

        <span class="n">ret_args</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2">* </span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">additional_arguments</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">in_signature</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">representation</span> <span class="o">!=</span> <span class="s2">&quot;named&quot;</span><span class="p">:</span>
            <span class="n">ret_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2">* </span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">array_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">result_name</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skip_result</span><span class="p">:</span>
                <span class="n">ret_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2">* </span><span class="si">{</span><span class="n">result_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ret_args</span><span class="p">)</span></div>

<div class="viewcode-block" id="CCodeGenerator.wrap_body_with_function_prototype"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.CCodeGenerator.wrap_body_with_function_prototype">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">wrap_body_with_function_prototype</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">body_lines</span><span class="p">,</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">args</span><span class="p">,</span>
        <span class="n">return_type</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">const</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrap a passed body of lines with a function prototype</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_arg</span><span class="p">(</span><span class="n">body_lines</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="n">check_arg</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">check_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">check_arg</span><span class="p">(</span><span class="n">return_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">check_arg</span><span class="p">(</span><span class="n">comment</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span>

        <span class="n">return_type</span> <span class="o">=</span> <span class="n">return_type</span> <span class="ow">or</span> <span class="s2">&quot;void&quot;</span>

        <span class="n">prototype</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
            <span class="n">prototype</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;// </span><span class="si">{</span><span class="n">comment</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">const</span> <span class="o">=</span> <span class="s2">&quot; const&quot;</span> <span class="k">if</span> <span class="n">const</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">prototype</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">return_type</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s2">)</span><span class="si">{</span><span class="n">const</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Append body to prototyp</span>
        <span class="n">prototype</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">body_lines</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">prototype</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_monitored_enum_val</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">monitored</span><span class="p">):</span>
        <span class="c1"># TODO: Check that state.name is valid suffix to an identifier in C</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;MONITOR_</span><span class="si">{</span><span class="n">monitored</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_state_enum_val</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="c1"># TODO: Check that state.name is valid suffix to an identifier in C</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;STATE_</span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_parameter_enum_val</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">parameter</span><span class="p">):</span>
        <span class="c1"># TODO: Check that parameter.name is valid suffix to an identifier in C</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;PARAM_</span><span class="si">{</span><span class="n">parameter</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="nf">_init_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp</span><span class="p">):</span>

        <span class="n">check_arg</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">CodeComponent</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span>
        <span class="n">default_arguments</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">params</span><span class="o">.</span><span class="n">default_arguments</span> <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">use_default_arguments</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>

        <span class="n">field_parameters</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="s2">&quot;field_parameters&quot;</span><span class="p">]</span>

        <span class="c1"># If empty</span>
        <span class="c1"># FIXME: Get rid of this by introducing a ListParam type in modelparameters</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_parameters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">field_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">field_parameters</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">state_offset</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;states&quot;</span><span class="p">][</span><span class="s2">&quot;add_offset&quot;</span><span class="p">]</span>
        <span class="n">parameter_offset</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="s2">&quot;add_offset&quot;</span><span class="p">]</span>
        <span class="n">field_parameter_offset</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="s2">&quot;add_field_offset&quot;</span><span class="p">]</span>

        <span class="c1"># Check if comp defines used_states if not use the root components</span>
        <span class="c1"># full_states attribute</span>
        <span class="c1"># FIXME: No need for full_states here...</span>
        <span class="n">full_states</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">full_states</span>
        <span class="n">used_states</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">used_states</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="s2">&quot;used_states&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">full_states</span>

        <span class="n">used_parameters</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">comp</span><span class="o">.</span><span class="n">used_parameters</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="s2">&quot;used_parameters&quot;</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">parameters</span>
        <span class="p">)</span>
        <span class="n">all_parameters</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">parameters</span>

        <span class="n">field_parameters</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">all_parameters</span> <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">field_parameters</span>
        <span class="p">]</span>

        <span class="c1"># Start building body</span>
        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">add_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">array_name</span><span class="p">,</span> <span class="n">add_offset</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">array_name</span><span class="si">}</span><span class="s2">_offset + &quot;</span> <span class="k">if</span> <span class="n">add_offset</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;const </span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2"> = </span><span class="si">{2}</span><span class="s2">[</span><span class="si">{3}{4}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">obj_name</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span>
                    <span class="n">array_name</span><span class="p">,</span>
                    <span class="n">offset</span><span class="p">,</span>
                    <span class="n">i</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;s&quot;</span> <span class="ow">in</span> <span class="n">default_arguments</span> <span class="ow">and</span> <span class="n">used_states</span><span class="p">:</span>

            <span class="c1"># Generate state assign code</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">representation</span> <span class="o">==</span> <span class="s2">&quot;named&quot;</span><span class="p">:</span>

                <span class="n">states_name</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;// Assign states&quot;</span><span class="p">)</span>

                <span class="c1"># If all states are used</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">full_states</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_states</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">][</span><span class="s2">&quot;use_enum&quot;</span><span class="p">]:</span>
                        <span class="n">add_obj</span><span class="p">(</span>
                            <span class="n">state</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_state_enum_val</span><span class="p">(</span><span class="n">state</span><span class="p">),</span>
                            <span class="n">states_name</span><span class="p">,</span>
                            <span class="n">state_offset</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">add_obj</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">states_name</span><span class="p">,</span> <span class="n">state_offset</span><span class="p">)</span>

        <span class="c1"># Add parameters code if not numerals</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="s2">&quot;p&quot;</span> <span class="ow">in</span> <span class="n">default_arguments</span>
            <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">representation</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;named&quot;</span><span class="p">,</span> <span class="s2">&quot;array&quot;</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">used_parameters</span>
        <span class="p">):</span>

            <span class="c1"># Generate parameters assign code</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">representation</span> <span class="o">==</span> <span class="s2">&quot;named&quot;</span><span class="p">:</span>

                <span class="n">parameters_name</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">array_name</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;// Assign parameters&quot;</span><span class="p">)</span>

                <span class="c1"># If all states are used</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_parameters</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">param</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_parameters</span> <span class="ow">or</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">field_parameters</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">][</span><span class="s2">&quot;use_enum&quot;</span><span class="p">]:</span>
                        <span class="n">add_obj</span><span class="p">(</span>
                            <span class="n">param</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_parameter_enum_val</span><span class="p">(</span><span class="n">param</span><span class="p">),</span>
                            <span class="n">parameters_name</span><span class="p">,</span>
                            <span class="n">parameter_offset</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">add_obj</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">parameters_name</span><span class="p">,</span> <span class="n">parameter_offset</span><span class="p">)</span>

                <span class="n">field_parameters_name</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">field_array_name</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">field_parameters</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">param</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_parameters</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">add_obj</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">field_parameters_name</span><span class="p">,</span> <span class="n">field_parameter_offset</span><span class="p">)</span>

        <span class="c1"># If using an array for the body variables and b is not passed as argument</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">representation</span> <span class="o">!=</span> <span class="s2">&quot;named&quot;</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">in_signature</span>
            <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">array_name</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">shapes</span>
        <span class="p">):</span>

            <span class="n">body_name</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">array_name</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;// Body array </span><span class="si">{</span><span class="n">body_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">body_name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">comp</span><span class="o">.</span><span class="n">shapes</span><span class="p">[</span><span class="n">body_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">body_lines</span>

<div class="viewcode-block" id="CCodeGenerator.states_enum_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.CCodeGenerator.states_enum_code">[docs]</a>    <span class="k">def</span> <span class="nf">states_enum_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate enum for state variables</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">indent_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indent</span> <span class="o">*</span> <span class="s2">&quot; &quot;</span>
        <span class="n">member_lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent_str</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">_state_enum_val</span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="si">}</span><span class="s2">,&quot;</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">ode</span><span class="o">.</span><span class="n">full_states</span>
        <span class="p">]</span>
        <span class="n">enum</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;enum state {&quot;</span><span class="p">]</span>
        <span class="n">enum</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">member_lines</span><span class="p">)</span>
        <span class="n">enum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent_str</span><span class="si">}</span><span class="s2">NUM_STATES,&quot;</span><span class="p">)</span>
        <span class="n">enum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;};&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">enum</span><span class="p">)</span></div>

<div class="viewcode-block" id="CCodeGenerator.parameters_enum_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.CCodeGenerator.parameters_enum_code">[docs]</a>    <span class="k">def</span> <span class="nf">parameters_enum_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate enum for model parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">indent_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indent</span> <span class="o">*</span> <span class="s2">&quot; &quot;</span>
        <span class="n">member_lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent_str</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">_parameter_enum_val</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span><span class="si">}</span><span class="s2">,&quot;</span>
            <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">ode</span><span class="o">.</span><span class="n">parameters</span>
        <span class="p">]</span>
        <span class="n">enum</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;enum parameter {&quot;</span><span class="p">]</span>
        <span class="n">enum</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">member_lines</span><span class="p">)</span>
        <span class="n">enum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent_str</span><span class="si">}</span><span class="s2">NUM_PARAMS,&quot;</span><span class="p">)</span>
        <span class="n">enum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;};&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">enum</span><span class="p">)</span></div>

<div class="viewcode-block" id="CCodeGenerator.monitored_enum_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.CCodeGenerator.monitored_enum_code">[docs]</a>    <span class="k">def</span> <span class="nf">monitored_enum_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monitored</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate enum for model parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">indent_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indent</span> <span class="o">*</span> <span class="s2">&quot; &quot;</span>
        <span class="n">member_lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent_str</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">_monitored_enum_val</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="si">}</span><span class="s2">,&quot;</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">monitored</span>
        <span class="p">]</span>
        <span class="n">enum</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;enum monitored {&quot;</span><span class="p">]</span>
        <span class="n">enum</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">member_lines</span><span class="p">)</span>
        <span class="n">enum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent_str</span><span class="si">}</span><span class="s2">NUM_MONITORED,&quot;</span><span class="p">)</span>
        <span class="n">enum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;};&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">enum</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_float_literal_str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s</span> <span class="ow">and</span> <span class="s2">&quot;e&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s</span> <span class="ow">and</span> <span class="s2">&quot;E&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;.0&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">float_precision</span> <span class="o">==</span> <span class="s2">&quot;single&quot;</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;f&quot;</span>
        <span class="k">return</span> <span class="n">s</span>

<div class="viewcode-block" id="CCodeGenerator.init_states_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.CCodeGenerator.init_states_code">[docs]</a>    <span class="k">def</span> <span class="nf">init_states_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate code for setting initial condition</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">states_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">states_name</span><span class="si">}</span><span class="s2">_offset + &quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">add_offset</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>

        <span class="n">enum_based_indexing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">][</span><span class="s2">&quot;use_enum&quot;</span><span class="p">]</span>
        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ode</span><span class="o">.</span><span class="n">full_states</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_enum_val</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="k">if</span> <span class="n">enum_based_indexing</span> <span class="k">else</span> <span class="n">i</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">[</span><span class="si">{1}{2}</span><span class="s2">] = </span><span class="si">{3}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">states_name</span><span class="p">,</span>
                <span class="n">offset</span><span class="p">,</span>
                <span class="n">index</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_float_literal_str</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">init</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">enum_based_indexing</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;; // </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="c1"># Add function prototype</span>
        <span class="n">init_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
            <span class="n">body_lines</span><span class="p">,</span>
            <span class="s2">&quot;init_state_values&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2">* </span><span class="si">{</span><span class="n">states_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Init state values&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">init_function</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span></div>

<div class="viewcode-block" id="CCodeGenerator.init_parameters_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.CCodeGenerator.init_parameters_code">[docs]</a>    <span class="k">def</span> <span class="nf">init_parameters_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate code for setting  parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">parameter_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">array_name</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parameter_name</span><span class="si">}</span><span class="s2">_offset + &quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">add_offset</span>
            <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">enum_based_indexing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">][</span><span class="s2">&quot;use_enum&quot;</span><span class="p">]</span>
        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ode</span><span class="o">.</span><span class="n">parameters</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameter_enum_val</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="k">if</span> <span class="n">enum_based_indexing</span> <span class="k">else</span> <span class="n">i</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">[</span><span class="si">{1}{2}</span><span class="s2">] = </span><span class="si">{3}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">parameter_name</span><span class="p">,</span>
                <span class="n">offset</span><span class="p">,</span>
                <span class="n">index</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_float_literal_str</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">init</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">enum_based_indexing</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;; // </span><span class="si">{</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="c1"># Add function prototype</span>
        <span class="n">init_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
            <span class="n">body_lines</span><span class="p">,</span>
            <span class="s2">&quot;init_parameters_values&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2">* </span><span class="si">{</span><span class="n">parameter_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Default parameter values&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">init_function</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span></div>

<div class="viewcode-block" id="CCodeGenerator.state_name_to_index_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.CCodeGenerator.state_name_to_index_code">[docs]</a>    <span class="k">def</span> <span class="nf">state_name_to_index_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return code for index handling for states</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_arg</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">ODE</span><span class="p">)</span>
        <span class="n">states</span> <span class="o">=</span> <span class="n">ode</span><span class="o">.</span><span class="n">full_states</span>

        <span class="n">max_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">][</span><span class="s2">&quot;use_enum&quot;</span><span class="p">]:</span>

            <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">states</span><span class="p">):</span>
                <span class="n">pre</span> <span class="o">=</span> <span class="s2">&quot;if&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;else if&quot;</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s1"> (strcmp(name, &quot;</span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;)==0)&#39;</span><span class="p">)</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;return </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_state_enum_val</span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;// State names&quot;</span><span class="p">]</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;char names[][</span><span class="si">{0}</span><span class="s2">] = {{</span><span class="si">{1}</span><span class="s2">}}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">max_length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="si">{0}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">),</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;int i&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;for (i=0; i&lt;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">states</span><span class="p">)</span><span class="si">}</span><span class="s2">; i++)&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;if (strcmp(names[i], name)==0)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;return i&quot;</span><span class="p">]])</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;return -1&quot;</span><span class="p">)</span>

        <span class="c1"># Add function prototype</span>
        <span class="n">function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
            <span class="n">body_lines</span><span class="p">,</span>
            <span class="s2">&quot;state_index&quot;</span><span class="p">,</span>
            <span class="s2">&quot;const char name[]&quot;</span><span class="p">,</span>
            <span class="s2">&quot;int&quot;</span><span class="p">,</span>
            <span class="s2">&quot;State index&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span></div>

<div class="viewcode-block" id="CCodeGenerator.param_name_to_index_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.CCodeGenerator.param_name_to_index_code">[docs]</a>    <span class="k">def</span> <span class="nf">param_name_to_index_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return code for index handling for a parameter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_arg</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">ODE</span><span class="p">)</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">ode</span><span class="o">.</span><span class="n">parameters</span>

        <span class="c1"># determine the longest parameter name</span>
        <span class="n">max_length</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># if there are no parameters, just use 1</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">max_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">][</span><span class="s2">&quot;use_enum&quot;</span><span class="p">]:</span>

            <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parameters</span><span class="p">):</span>
                <span class="n">pre</span> <span class="o">=</span> <span class="s2">&quot;if&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;else if&quot;</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s1"> (strcmp(name, &quot;</span><span class="si">{</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;)==0)&#39;</span><span class="p">)</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;return </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_parameter_enum_val</span><span class="p">(</span><span class="n">param</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;// Parameter names&quot;</span><span class="p">]</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;char names[][</span><span class="si">{0}</span><span class="s2">] = {{</span><span class="si">{1}</span><span class="s2">}}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">max_length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="si">{0}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">),</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;int i&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;for (i=0; i&lt;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span><span class="si">}</span><span class="s2">; i++)&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;if (strcmp(names[i], name)==0)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;return i&quot;</span><span class="p">]])</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;return -1&quot;</span><span class="p">)</span>

        <span class="c1"># Add function prototype</span>
        <span class="n">function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
            <span class="n">body_lines</span><span class="p">,</span>
            <span class="s2">&quot;parameter_index&quot;</span><span class="p">,</span>
            <span class="s2">&quot;const char name[]&quot;</span><span class="p">,</span>
            <span class="s2">&quot;int&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Parameter index&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span></div>

<div class="viewcode-block" id="CCodeGenerator.monitor_name_to_index_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.CCodeGenerator.monitor_name_to_index_code">[docs]</a>    <span class="k">def</span> <span class="nf">monitor_name_to_index_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">monitored</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return code for index handling for monitored</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">max_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">monitor</span><span class="p">)</span> <span class="k">for</span> <span class="n">monitor</span> <span class="ow">in</span> <span class="n">monitored</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">][</span><span class="s2">&quot;use_enum&quot;</span><span class="p">]:</span>

            <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">monitored</span><span class="p">):</span>
                <span class="n">pre</span> <span class="o">=</span> <span class="s2">&quot;if&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;else if&quot;</span>

                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s1"> (strcmp(name, &quot;</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s1">&quot;)==0)&#39;</span><span class="p">)</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;return </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_monitored_enum_val</span><span class="p">(</span><span class="n">param</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;// Monitored names&quot;</span><span class="p">]</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;char names[][</span><span class="si">{0}</span><span class="s2">] = {{</span><span class="si">{1}</span><span class="s2">}}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">max_length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="si">{0}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">monitor</span><span class="p">)</span> <span class="k">for</span> <span class="n">monitor</span> <span class="ow">in</span> <span class="n">monitored</span><span class="p">),</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;for (int i=0; i&lt;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span><span class="si">}</span><span class="s2">; i++)&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;if (strcmp(names[i], name)==0)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;return i&quot;</span><span class="p">]])</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;return -1&quot;</span><span class="p">)</span>

        <span class="c1"># Add function prototype</span>
        <span class="n">function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
            <span class="n">body_lines</span><span class="p">,</span>
            <span class="s2">&quot;monitored_index&quot;</span><span class="p">,</span>
            <span class="s2">&quot;const char name[]&quot;</span><span class="p">,</span>
            <span class="s2">&quot;int&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span></div>

<div class="viewcode-block" id="CCodeGenerator.function_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.CCodeGenerator.function_code">[docs]</a>    <span class="k">def</span> <span class="nf">function_code</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">comp</span><span class="p">,</span>
        <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">default_arguments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">include_signature</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">return_body_lines</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span>
        <span class="n">default_arguments</span> <span class="o">=</span> <span class="n">default_arguments</span> <span class="ow">or</span> <span class="n">params</span><span class="o">.</span><span class="n">default_arguments</span>

        <span class="n">check_arg</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">CodeComponent</span><span class="p">)</span>
        <span class="n">check_kwarg</span><span class="p">(</span><span class="n">default_arguments</span><span class="p">,</span> <span class="s2">&quot;default_arguments&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">check_kwarg</span><span class="p">(</span><span class="n">indent</span><span class="p">,</span> <span class="s2">&quot;indent&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>

        <span class="n">body_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_arguments</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>

        <span class="c1"># If named body representation we need to check for duplicates</span>
        <span class="n">duplicates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">declared_duplicates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">representation</span> <span class="o">==</span> <span class="s2">&quot;named&quot;</span><span class="p">:</span>
            <span class="n">collected_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">body_expressions</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
                    <span class="n">expr</span><span class="p">,</span>
                    <span class="n">IndexedExpression</span><span class="p">,</span>
                <span class="p">):</span>
                    <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">collected_names</span><span class="p">:</span>
                        <span class="n">duplicates</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">collected_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Iterate over any body needed to define the dy</span>
        <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">body_expressions</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Comment</span><span class="p">):</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;// &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">IndexedExpression</span><span class="p">)</span>
                <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">StateIndexedExpression</span><span class="p">)</span>
                <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ParameterIndexedExpression</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">][</span><span class="s2">&quot;use_enum&quot;</span><span class="p">]:</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">StateIndexedExpression</span><span class="p">):</span>

                        <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">basename</span> <span class="o">==</span> <span class="s2">&quot;monitored&quot;</span><span class="p">:</span>
                            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">[</span><span class="si">{1}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">expr</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_monitored_enum_val</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_monitored_index_to_name</span><span class="p">[</span><span class="n">expr</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                <span class="p">),</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">[</span><span class="si">{1}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">expr</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_state_enum_val</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">state</span><span class="p">),</span>
                            <span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ParameterIndexedExpression</span><span class="p">):</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">[</span><span class="si">{1}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">expr</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_parameter_enum_val</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">parameter</span><span class="p">),</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">IndexedExpression</span><span class="p">):</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">[</span><span class="si">{1}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">expr</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_monitored_enum_val</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_monitored_index_to_name</span><span class="p">[</span><span class="n">expr</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                            <span class="p">),</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;Cannot enumerate expression </span><span class="si">{0}</span><span class="s2"> of type </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">expr</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span>
                                <span class="nb">type</span><span class="p">(</span><span class="n">expr</span><span class="p">),</span>
                            <span class="p">),</span>
                        <span class="p">)</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">expr</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">expr</span><span class="o">.</span><span class="n">enum</span><span class="si">}</span><span class="s2">]&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">obj_name</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">declared_duplicates</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">obj_name</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">declared_duplicates</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">obj_name</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;const </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">obj_name</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_code</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">return_body_lines</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">body_lines</span>

        <span class="k">if</span> <span class="n">include_signature</span><span class="p">:</span>

            <span class="c1"># Add function prototype</span>
            <span class="n">body_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
                <span class="n">body_lines</span><span class="p">,</span>
                <span class="n">comp</span><span class="o">.</span><span class="n">function_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">(</span><span class="n">comp</span><span class="p">),</span>
                <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">comp</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">body_lines</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span></div>

<div class="viewcode-block" id="CCodeGenerator.componentwise_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.CCodeGenerator.componentwise_code">[docs]</a>    <span class="k">def</span> <span class="nf">componentwise_code</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ode</span><span class="p">,</span>
        <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">default_arguments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">include_signature</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">return_body_lines</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span>
        <span class="n">default_arguments</span> <span class="o">=</span> <span class="n">default_arguments</span> <span class="ow">or</span> <span class="n">params</span><span class="o">.</span><span class="n">default_arguments</span>

        <span class="n">float_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">float_precision</span> <span class="o">==</span> <span class="s2">&quot;double&quot;</span> <span class="k">else</span> <span class="s2">&quot;f&quot;</span>

        <span class="c1"># Create code for each individuate component</span>
        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;// Return value&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2"> dy_comp[1] = </span><span class="se">{{</span><span class="s2">0.0</span><span class="si">{</span><span class="n">float_str</span><span class="si">}</span><span class="se">}}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;// What component?&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;switch (id)&quot;</span><span class="p">)</span>

        <span class="n">switch_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ode</span><span class="o">.</span><span class="n">full_states</span><span class="p">):</span>

            <span class="n">component_code</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;// Component </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> state </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;case </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">,</span>
            <span class="p">]</span>

            <span class="n">comp</span> <span class="o">=</span> <span class="n">componentwise_derivative</span><span class="p">(</span>
                <span class="n">ode</span><span class="p">,</span>
                <span class="n">i</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
                <span class="n">result_name</span><span class="o">=</span><span class="s2">&quot;dy_comp&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">component_code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">function_code</span><span class="p">(</span>
                    <span class="n">comp</span><span class="p">,</span>
                    <span class="n">indent</span><span class="p">,</span>
                    <span class="n">default_arguments</span><span class="p">,</span>
                    <span class="n">include_signature</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">return_body_lines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">component_code</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;break&quot;</span><span class="p">)</span>

            <span class="n">switch_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">component_code</span><span class="p">)</span>

        <span class="n">default_lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;// Default&quot;</span><span class="p">,</span> <span class="s2">&quot;default:&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">language</span> <span class="o">==</span> <span class="s2">&quot;C++&quot;</span><span class="p">:</span>
            <span class="n">default_lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;throw std::runtime_error(&quot;Index out of bounds&quot;)&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">default_lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;// Throw an exception...&quot;</span><span class="p">])</span>

        <span class="n">switch_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">default_lines</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">switch_lines</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;// Return component&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;return dy_comp[0]&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_body_lines</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">body_lines</span>

        <span class="c1"># Add function prototype</span>
        <span class="k">if</span> <span class="n">include_signature</span><span class="p">:</span>
            <span class="n">body_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
                <span class="n">body_lines</span><span class="p">,</span>
                <span class="s2">&quot;rhs&quot;</span><span class="p">,</span>
                <span class="s2">&quot;unsigned int id, &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">(</span><span class="n">comp</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="p">,</span>
                <span class="s2">&quot;Evaluate componenttwise rhs of the ODE&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">body_lines</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span></div>

<div class="viewcode-block" id="CCodeGenerator.mass_matrix"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.CCodeGenerator.mass_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">mass_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Generation of componentwise_rhs_evaluation code is not &quot;</span>
            <span class="s2">&quot;yet implemented for the C backend.&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="CCodeGenerator.module_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.CCodeGenerator.module_code">[docs]</a>    <span class="k">def</span> <span class="nf">module_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">monitored</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;// Gotran generated C/C++ code for the &quot;</span><span class="si">{0}</span><span class="s2">&quot; model</span>

<span class="si">{1}</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">ode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code_dict</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">monitored</span><span class="o">=</span><span class="n">monitored</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">())),</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="CppCodeGenerator"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.CppCodeGenerator">[docs]</a><span class="k">class</span> <span class="nc">CppCodeGenerator</span><span class="p">(</span><span class="n">CCodeGenerator</span><span class="p">):</span>

    <span class="n">language</span> <span class="o">=</span> <span class="s2">&quot;C++&quot;</span>

    <span class="c1"># Class attributes</span>
    <span class="n">to_code</span> <span class="o">=</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">cppcode</span><span class="p">(</span>
        <span class="n">expr</span><span class="p">,</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">float_precision</span><span class="p">,</span>
    <span class="p">)</span>

<div class="viewcode-block" id="CppCodeGenerator.class_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.CppCodeGenerator.class_code">[docs]</a>    <span class="k">def</span> <span class="nf">class_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">monitored</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clsname</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate class code</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">clsname</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">clsname</span> <span class="o">=</span> <span class="n">class_name</span><span class="p">(</span><span class="n">ode</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">// Gotran generated C++ class for the &quot;</span><span class="si">{0}</span><span class="s2">&quot; model</span>
<span class="s2">class </span><span class="si">{1}</span><span class="s2"></span>
<span class="s2">{{</span>

<span class="s2">public:</span>

<span class="si">{2}</span><span class="s2"></span>

<span class="s2">}};</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">ode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">clsname</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code_dict</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">monitored</span><span class="o">=</span><span class="n">monitored</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="p">),</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="CUDACodeGenerator"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.CUDACodeGenerator">[docs]</a><span class="k">class</span> <span class="nc">CUDACodeGenerator</span><span class="p">(</span><span class="n">CCodeGenerator</span><span class="p">):</span>
    <span class="c1"># Class attributes</span>
    <span class="n">language</span> <span class="o">=</span> <span class="s2">&quot;CUDA&quot;</span>
    <span class="n">indent</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CUDACodeGenerator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">use_enum</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s2">&quot;code.body.use_enum cannot be disabled for CUDA&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">representation</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s2">&quot;array representation of states is unsupported for CUDA&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">representation</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s2">&quot;array representation of parameters is unsupported for CUDA&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="CUDACodeGenerator.default_parameters"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.CUDACodeGenerator.default_parameters">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">default_parameters</span><span class="p">():</span>
        <span class="c1"># Start out with a copy of the global parameters</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">generation</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">use_enum</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">add_offset</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span> <span class="o">=</span> <span class="s2">&quot;d_states&quot;</span>
        <span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">add_field_offset</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">array_name</span> <span class="o">=</span> <span class="s2">&quot;d_parameters&quot;</span>
        <span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">field_array_name</span> <span class="o">=</span> <span class="s2">&quot;d_field_parameters&quot;</span>
        <span class="k">return</span> <span class="n">params</span></div>

<div class="viewcode-block" id="CUDACodeGenerator.wrap_body_with_function_prototype"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.CUDACodeGenerator.wrap_body_with_function_prototype">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">wrap_body_with_function_prototype</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">body_lines</span><span class="p">,</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">args</span><span class="p">,</span>
        <span class="n">return_type</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">const</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">kernel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrap a passed body of lines with a function prototype</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_arg</span><span class="p">(</span><span class="n">return_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

        <span class="n">return_type</span> <span class="o">=</span> <span class="n">return_type</span> <span class="ow">or</span> <span class="s2">&quot;void&quot;</span>

        <span class="k">if</span> <span class="n">kernel</span><span class="p">:</span>
            <span class="n">return_type</span> <span class="o">=</span> <span class="s2">&quot;__global__ &quot;</span> <span class="o">+</span> <span class="n">return_type</span>
        <span class="k">elif</span> <span class="n">device</span><span class="p">:</span>
            <span class="n">return_type</span> <span class="o">=</span> <span class="s2">&quot;__device__ &quot;</span> <span class="o">+</span> <span class="n">return_type</span>

        <span class="c1"># Call super class function wrapper</span>
        <span class="k">return</span> <span class="n">CCodeGenerator</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
            <span class="n">body_lines</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">args</span><span class="p">,</span>
            <span class="n">return_type</span><span class="p">,</span>
            <span class="n">comment</span><span class="p">,</span>
            <span class="n">const</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_init_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp</span><span class="p">):</span>
        <span class="n">check_arg</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">CodeComponent</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span>
        <span class="n">default_arguments</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">params</span><span class="o">.</span><span class="n">default_arguments</span> <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">use_default_arguments</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>

        <span class="n">field_parameters</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="s2">&quot;field_parameters&quot;</span><span class="p">]</span>

        <span class="c1"># If empty</span>
        <span class="c1"># FIXME: Get rid of this by introducing a ListParam type in modelparameters</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_parameters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">field_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">field_parameters</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># state_offset = params[&quot;states&quot;][&quot;add_offset&quot;]</span>
        <span class="n">parameter_offset</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="s2">&quot;add_offset&quot;</span><span class="p">]</span>
        <span class="n">field_parameter_offset</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="s2">&quot;add_field_offset&quot;</span><span class="p">]</span>

        <span class="c1"># Check if comp defines used_states if not use the root components</span>
        <span class="c1"># full_states attribute</span>
        <span class="c1"># FIXME: No need for full_states here...</span>
        <span class="n">full_states</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">full_states</span>
        <span class="n">used_states</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">used_states</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="s2">&quot;used_states&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">full_states</span>

        <span class="n">used_parameters</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">comp</span><span class="o">.</span><span class="n">used_parameters</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="s2">&quot;used_parameters&quot;</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">parameters</span>
        <span class="p">)</span>
        <span class="n">all_parameters</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">parameters</span>

        <span class="n">field_parameters</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">all_parameters</span> <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">field_parameters</span>
        <span class="p">]</span>

        <span class="c1"># Start building body</span>
        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">add_state_obj</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">enum_val</span><span class="p">,</span> <span class="n">array_name</span><span class="p">):</span>
            <span class="n">index_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;n_nodes * </span><span class="si">{</span><span class="n">enum_val</span><span class="si">}</span><span class="s2"> + thread_ind&quot;</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;const </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">array_name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">index_str</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">def</span> <span class="nf">add_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">array_name</span><span class="p">,</span> <span class="n">add_offset</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">array_name</span><span class="si">}</span><span class="s2">_offset + &quot;</span> <span class="k">if</span> <span class="n">add_offset</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;const </span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2"> = </span><span class="si">{2}</span><span class="s2">[</span><span class="si">{3}{4}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">obj_name</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span>
                    <span class="n">array_name</span><span class="p">,</span>
                    <span class="n">offset</span><span class="p">,</span>
                    <span class="n">i</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;s&quot;</span> <span class="ow">in</span> <span class="n">default_arguments</span> <span class="ow">and</span> <span class="n">used_states</span><span class="p">:</span>

            <span class="c1"># Generate state assign code</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">representation</span> <span class="o">==</span> <span class="s2">&quot;named&quot;</span><span class="p">:</span>

                <span class="n">states_name</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;// Assign states&quot;</span><span class="p">)</span>

                <span class="c1"># If all states are used</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">full_states</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_states</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="c1"># add_obj(state, i, states_name, state_offset)</span>
                    <span class="c1"># add_obj(state, self._state_enum_val(state), states_name, state_offset)</span>
                    <span class="n">add_state_obj</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_enum_val</span><span class="p">(</span><span class="n">state</span><span class="p">),</span> <span class="n">states_name</span><span class="p">)</span>

        <span class="c1"># Add parameters code if not numerals</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="s2">&quot;p&quot;</span> <span class="ow">in</span> <span class="n">default_arguments</span>
            <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">representation</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;named&quot;</span><span class="p">,</span> <span class="s2">&quot;array&quot;</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">used_parameters</span>
        <span class="p">):</span>

            <span class="c1"># Generate parameters assign code</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">representation</span> <span class="o">==</span> <span class="s2">&quot;named&quot;</span><span class="p">:</span>

                <span class="n">parameters_name</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">array_name</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;// Assign parameters&quot;</span><span class="p">)</span>

                <span class="c1"># If all states are used</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_parameters</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">param</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_parameters</span> <span class="ow">or</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">field_parameters</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="c1"># add_obj(param, i, parameters_name, parameter_offset)</span>
                    <span class="n">add_obj</span><span class="p">(</span>
                        <span class="n">param</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_parameter_enum_val</span><span class="p">(</span><span class="n">param</span><span class="p">),</span>
                        <span class="n">parameters_name</span><span class="p">,</span>
                        <span class="n">parameter_offset</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="n">field_parameters_name</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">field_array_name</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">field_parameters</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">param</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_parameters</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">add_obj</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">field_parameters_name</span><span class="p">,</span> <span class="n">field_parameter_offset</span><span class="p">)</span>

        <span class="c1"># If using an array for the body variables and b is not passed as argument</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">representation</span> <span class="o">!=</span> <span class="s2">&quot;named&quot;</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">in_signature</span>
            <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">array_name</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">shapes</span>
        <span class="p">):</span>

            <span class="n">body_name</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">array_name</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;// Body array </span><span class="si">{</span><span class="n">body_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">body_name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">comp</span><span class="o">.</span><span class="n">shapes</span><span class="p">[</span><span class="n">body_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">body_lines</span>

<div class="viewcode-block" id="CUDACodeGenerator.init_states_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.CUDACodeGenerator.init_states_code">[docs]</a>    <span class="k">def</span> <span class="nf">init_states_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate code for setting initial condition</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">array_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span>
        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;const int thread_ind = blockIdx.x*blockDim.x + threadIdx.x&quot;</span><span class="p">]</span>
        <span class="n">n_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">n_nodes</span>
        <span class="k">if</span> <span class="n">n_nodes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;if (thread_ind &gt;= n_nodes) return; &quot;</span> <span class="s2">&quot;// number of nodes exceeded&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="c1"># body_lines.append(&quot;const int {0}_offset = thread_ind*{1}&quot;.format(\</span>
        <span class="c1">#    array_name, ode.num_full_states))</span>

        <span class="c1"># Main body</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">[n_nodes * </span><span class="si">{1}</span><span class="s2"> + thread_ind] = </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">array_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state_enum_val</span><span class="p">(</span><span class="n">state</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_float_literal_str</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">init</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ode</span><span class="o">.</span><span class="n">full_states</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Add function prototype</span>
        <span class="n">init_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
            <span class="n">body_lines</span><span class="p">,</span>
            <span class="s2">&quot;init_state_values&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2"> *</span><span class="si">{</span><span class="n">array_name</span><span class="si">}</span><span class="s2">, const unsigned int n_nodes&quot;</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;Init state values&quot;</span><span class="p">,</span>
            <span class="n">kernel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">init_function</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span></div>

<div class="viewcode-block" id="CUDACodeGenerator.init_parameters_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.CUDACodeGenerator.init_parameters_code">[docs]</a>    <span class="k">def</span> <span class="nf">init_parameters_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate code for setting parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># FIXME: Parameters should be stored in a __constant__ array.</span>
        <span class="c1"># We could have a function to initialise that array.</span>
        <span class="c1"># For now, just initialise the arrays in host memory.</span>
        <span class="k">return</span> <span class="n">CCodeGenerator</span><span class="o">.</span><span class="n">init_parameters_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="p">)</span></div>

<div class="viewcode-block" id="CUDACodeGenerator.init_field_parameters_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.CUDACodeGenerator.init_field_parameters_code">[docs]</a>    <span class="k">def</span> <span class="nf">init_field_parameters_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate code for initialising field parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">field_parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">field_parameters</span>

        <span class="c1"># If empty</span>
        <span class="c1"># FIXME: Get rid of this by introducing a ListParam type in modelparameters</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_parameters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">field_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">field_parameters</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">array_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">array_name</span>
        <span class="n">base_array_name</span> <span class="o">=</span> <span class="n">array_name</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="k">if</span> <span class="n">array_name</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;d_&quot;</span> <span class="k">else</span> <span class="n">array_name</span>
        <span class="n">field_array_name</span> <span class="o">=</span> <span class="s2">&quot;d_field_&quot;</span> <span class="o">+</span> <span class="n">base_array_name</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="n">ode</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">parameter_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">]</span>
        <span class="n">field_parameter_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">parameter_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">field_parameters</span><span class="p">]</span>
        <span class="n">num_field_parameters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_parameters</span><span class="p">)</span>

        <span class="n">body_lines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">num_field_parameters</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;const int thread_ind = blockIdx.x*blockDim.x + threadIdx.x&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">n_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">n_nodes</span>
            <span class="k">if</span> <span class="n">n_nodes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;if (thread_ind &gt;= </span><span class="si">{</span><span class="n">n_nodes</span><span class="si">}</span><span class="s2">) return; // number of nodes exceeded&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;const int field_</span><span class="si">{0}</span><span class="s2">_offset = thread_ind*</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">base_array_name</span><span class="p">,</span>
                    <span class="n">num_field_parameters</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># Main body</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">[field_</span><span class="si">{1}</span><span class="s2">_offset + </span><span class="si">{2}</span><span class="s2">] = </span><span class="si">{3}</span><span class="s2">; //</span><span class="si">{4}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">field_array_name</span><span class="p">,</span>
                <span class="n">base_array_name</span><span class="p">,</span>
                <span class="n">i</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_float_literal_str</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="n">field_parameter_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">init</span><span class="p">),</span>
                <span class="n">field_parameter</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">field_parameter</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">field_parameters</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Add function prototype</span>
        <span class="n">init_fparam_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
            <span class="n">body_lines</span><span class="p">,</span>
            <span class="s2">&quot;init_field_parameters&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2"> *</span><span class="si">{</span><span class="n">field_array_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;Initialize field parameters&quot;</span><span class="p">,</span>
            <span class="n">kernel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">init_fparam_func</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span></div>

<div class="viewcode-block" id="CUDACodeGenerator.field_parameters_setter_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.CUDACodeGenerator.field_parameters_setter_code">[docs]</a>    <span class="k">def</span> <span class="nf">field_parameters_setter_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c1"># FIXME: Implement!</span>
        <span class="c1"># This is actually not needed</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span></div>

<div class="viewcode-block" id="CUDACodeGenerator.field_states_getter_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.CUDACodeGenerator.field_states_getter_code">[docs]</a>    <span class="k">def</span> <span class="nf">field_states_getter_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate code for field state getter</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">field_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">field_states</span>

        <span class="c1"># If empty</span>
        <span class="c1"># FIXME: Get rid of this by introducing a ListParam type in modelparameters</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_states</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">field_states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">field_states</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">array_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span>
        <span class="n">base_array_name</span> <span class="o">=</span> <span class="n">array_name</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="k">if</span> <span class="n">array_name</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;d_&quot;</span> <span class="k">else</span> <span class="n">array_name</span>
        <span class="n">field_array_name</span> <span class="o">=</span> <span class="s2">&quot;h_field_&quot;</span> <span class="o">+</span> <span class="n">base_array_name</span>

        <span class="n">states</span> <span class="o">=</span> <span class="n">ode</span><span class="o">.</span><span class="n">full_states</span>
        <span class="c1"># FIXME: Check that the state is really a state</span>
        <span class="n">field_states</span> <span class="o">=</span> <span class="p">[</span><span class="n">state</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span> <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">field_states</span><span class="p">]</span>

        <span class="n">num_field_states</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_states</span><span class="p">)</span>
        <span class="n">array_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span>

        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">num_field_states</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;const int thread_ind = blockIdx.x*blockDim.x + threadIdx.x&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">n_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">n_nodes</span>
            <span class="k">if</span> <span class="n">n_nodes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;if (thread_ind &gt;= </span><span class="si">{</span><span class="n">n_nodes</span><span class="si">}</span><span class="s2">) return; // number of nodes exceeded&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;const int </span><span class="si">{</span><span class="n">base_array_name</span><span class="si">}</span><span class="s2">_offset = thread_ind*</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">states</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;const int field_</span><span class="si">{0}</span><span class="s2">_offset = thread_ind*</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">base_array_name</span><span class="p">,</span>
                    <span class="n">num_field_states</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># Main body</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">[field_</span><span class="si">{2}</span><span class="s2">_offset + </span><span class="si">{3}</span><span class="s2">] = &quot;</span>
            <span class="s2">&quot;</span><span class="si">{1}</span><span class="s2">[</span><span class="si">{2}</span><span class="s2">_offset + </span><span class="si">{4}</span><span class="s2">]; //</span><span class="si">{5}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">field_array_name</span><span class="p">,</span>
                <span class="n">array_name</span><span class="p">,</span>
                <span class="n">base_array_name</span><span class="p">,</span>
                <span class="n">i</span><span class="p">,</span>
                <span class="n">states</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">state</span><span class="p">),</span>
                <span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">field_states</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Add function prototype</span>
        <span class="n">getter_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
            <span class="n">body_lines</span><span class="p">,</span>
            <span class="s2">&quot;get_field_states&quot;</span><span class="p">,</span>
            <span class="s2">&quot;const </span><span class="si">{0}</span><span class="s2"> *</span><span class="si">{1}</span><span class="s2">, </span><span class="si">{0}</span><span class="s2"> *</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="p">,</span>
                <span class="n">array_name</span><span class="p">,</span>
                <span class="n">field_array_name</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;Get field states&quot;</span><span class="p">,</span>
            <span class="n">kernel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">getter_func</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span></div>

<div class="viewcode-block" id="CUDACodeGenerator.field_states_setter_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.CUDACodeGenerator.field_states_setter_code">[docs]</a>    <span class="k">def</span> <span class="nf">field_states_setter_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate code for field state setter</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">field_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">field_states</span>

        <span class="c1"># If empty</span>
        <span class="c1"># FIXME: Get rid of this by introducing a ListParam type in modelparameters</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_states</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">field_states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">field_states</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">array_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span>
        <span class="n">base_array_name</span> <span class="o">=</span> <span class="n">array_name</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="k">if</span> <span class="n">array_name</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;d_&quot;</span> <span class="k">else</span> <span class="n">array_name</span>
        <span class="n">field_array_name</span> <span class="o">=</span> <span class="s2">&quot;h_field_&quot;</span> <span class="o">+</span> <span class="n">base_array_name</span>

        <span class="n">states</span> <span class="o">=</span> <span class="n">ode</span><span class="o">.</span><span class="n">full_states</span>
        <span class="c1"># FIXME: Check that the state is really a state</span>
        <span class="n">field_states</span> <span class="o">=</span> <span class="p">[</span><span class="n">state</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span> <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">field_states</span><span class="p">]</span>

        <span class="n">num_field_states</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_states</span><span class="p">)</span>

        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">num_field_states</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;const int thread_ind = blockIdx.x*blockDim.x + threadIdx.x&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">n_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">n_nodes</span>
            <span class="k">if</span> <span class="n">n_nodes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;if (thread_ind &gt;= </span><span class="si">{</span><span class="n">n_nodes</span><span class="si">}</span><span class="s2">) return; // number of nodes exceeded&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;const int </span><span class="si">{</span><span class="n">base_array_name</span><span class="si">}</span><span class="s2">_offset = thread_ind*</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">states</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;const int field_</span><span class="si">{0}</span><span class="s2">_offset = thread_ind*</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">base_array_name</span><span class="p">,</span>
                    <span class="n">num_field_states</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># Main body</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">[</span><span class="si">{2}</span><span class="s2">_offset + </span><span class="si">{3}</span><span class="s2">] = &quot;</span>
            <span class="s2">&quot;</span><span class="si">{1}</span><span class="s2">[field_</span><span class="si">{2}</span><span class="s2">_offset + </span><span class="si">{4}</span><span class="s2">]; //</span><span class="si">{5}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">array_name</span><span class="p">,</span>
                <span class="n">field_array_name</span><span class="p">,</span>
                <span class="n">base_array_name</span><span class="p">,</span>
                <span class="n">states</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">state</span><span class="p">),</span>
                <span class="n">i</span><span class="p">,</span>
                <span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">field_states</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Add function prototype</span>
        <span class="n">setter_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
            <span class="n">body_lines</span><span class="p">,</span>
            <span class="s2">&quot;set_field_states&quot;</span><span class="p">,</span>
            <span class="s2">&quot;const </span><span class="si">{0}</span><span class="s2"> *</span><span class="si">{1}</span><span class="s2">, </span><span class="si">{0}</span><span class="s2"> *</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="p">,</span>
                <span class="n">field_array_name</span><span class="p">,</span>
                <span class="n">array_name</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;Set field states&quot;</span><span class="p">,</span>
            <span class="n">kernel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">setter_func</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span></div>

<div class="viewcode-block" id="CUDACodeGenerator.function_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.CUDACodeGenerator.function_code">[docs]</a>    <span class="k">def</span> <span class="nf">function_code</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">comp</span><span class="p">,</span>
        <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">default_arguments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">include_signature</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">return_body_lines</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span>
        <span class="n">field_parameters</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">field_parameters</span>

        <span class="c1"># If empty</span>
        <span class="c1"># FIXME: Get rid of this by introducing a ListParam type in modelparameters</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_parameters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">field_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">field_parameters</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">default_arguments</span> <span class="o">=</span> <span class="n">default_arguments</span> <span class="ow">or</span> <span class="n">params</span><span class="o">.</span><span class="n">default_arguments</span>

        <span class="n">check_arg</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">CodeComponent</span><span class="p">)</span>
        <span class="n">check_kwarg</span><span class="p">(</span><span class="n">default_arguments</span><span class="p">,</span> <span class="s2">&quot;default_arguments&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">check_kwarg</span><span class="p">(</span><span class="n">indent</span><span class="p">,</span> <span class="s2">&quot;indent&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="n">field_parameter_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">field_array_name</span>

        <span class="c1"># Initialization</span>
        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;const int thread_ind = blockIdx.x*blockDim.x + threadIdx.x&quot;</span><span class="p">]</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;if (thread_ind &gt;= n_nodes) return; &quot;</span> <span class="s2">&quot;// number of nodes exceeded&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_parameters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;const int </span><span class="si">{0}</span><span class="s2">_offset = thread_ind*</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">field_parameter_name</span><span class="p">,</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">field_parameters</span><span class="p">),</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="n">body_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_init_arguments</span><span class="p">(</span><span class="n">comp</span><span class="p">))</span>

        <span class="c1"># If named body representation we need to check for duplicates</span>
        <span class="n">duplicates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">declared_duplicates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">representation</span> <span class="o">==</span> <span class="s2">&quot;named&quot;</span><span class="p">:</span>
            <span class="n">collected_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">body_expressions</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
                    <span class="n">expr</span><span class="p">,</span>
                    <span class="n">IndexedExpression</span><span class="p">,</span>
                <span class="p">):</span>
                    <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">collected_names</span><span class="p">:</span>
                        <span class="n">duplicates</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">collected_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Iterate over any body needed to define the dy</span>
        <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">body_expressions</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Comment</span><span class="p">):</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;// &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">IndexedExpression</span><span class="p">)</span>
                <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">StateIndexedExpression</span><span class="p">)</span>
                <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ParameterIndexedExpression</span><span class="p">)</span>
            <span class="p">):</span>

                <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">][</span><span class="s2">&quot;use_enum&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">StateIndexedExpression</span><span class="p">):</span>
                        <span class="n">state_enum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_enum_val</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
                        <span class="n">index_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;n_nodes * </span><span class="si">{</span><span class="n">state_enum</span><span class="si">}</span><span class="s2"> + thread_ind&quot;</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">expr</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">index_str</span><span class="si">}</span><span class="s2">]&quot;</span>
                        <span class="c1"># name = &quot;{0}[{1}]&quot;.format(expr.basename,self._state_enum_val(expr.state))</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ParameterIndexedExpression</span><span class="p">):</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">[</span><span class="si">{1}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">expr</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_parameter_enum_val</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">parameter</span><span class="p">),</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;Cannot enumerate expression </span><span class="si">{0}</span><span class="s2"> of type </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">expr</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span>
                                <span class="nb">type</span><span class="p">(</span><span class="n">expr</span><span class="p">),</span>
                            <span class="p">),</span>
                        <span class="p">)</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">expr</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">expr</span><span class="o">.</span><span class="n">enum</span><span class="si">}</span><span class="s2">]&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">obj_name</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">declared_duplicates</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">obj_name</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">declared_duplicates</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">obj_name</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;const </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">obj_name</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_code</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">return_body_lines</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">body_lines</span>

        <span class="k">if</span> <span class="n">include_signature</span><span class="p">:</span>
            <span class="c1"># Add function prototype</span>
            <span class="n">body_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
                <span class="n">body_lines</span><span class="p">,</span>
                <span class="n">comp</span><span class="o">.</span><span class="n">function_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, const unsigned int n_nodes&quot;</span><span class="p">,</span>
                <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">comp</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="n">kernel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">body_lines</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span></div>

<div class="viewcode-block" id="CUDACodeGenerator.module_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.CUDACodeGenerator.module_code">[docs]</a>    <span class="k">def</span> <span class="nf">module_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">monitored</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">code_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">code_dict</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">monitored</span><span class="o">=</span><span class="n">monitored</span><span class="p">,</span> <span class="n">include_index_map</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="n">code_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_states_getter_code</span><span class="p">(</span><span class="n">ode</span><span class="p">))</span>
        <span class="n">code_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_states_setter_code</span><span class="p">(</span><span class="n">ode</span><span class="p">))</span>
        <span class="n">code_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_parameters_setter_code</span><span class="p">(</span><span class="n">ode</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;// Gotran generated </span><span class="si">{2}</span><span class="s2"> code for the &quot;</span><span class="si">{0}</span><span class="s2">&quot; model</span>

<span class="si">{1}</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">ode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">code_list</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">language</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="CUDACodeGenerator.solver_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.CUDACodeGenerator.solver_code">[docs]</a>    <span class="k">def</span> <span class="nf">solver_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">solver_type</span><span class="p">):</span>
        <span class="n">code_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">code_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_code</span><span class="p">(</span>
                <span class="n">get_solver_fn</span><span class="p">(</span><span class="n">solver_type</span><span class="p">)(</span><span class="n">ode</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">code_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_states_code</span><span class="p">(</span><span class="n">ode</span><span class="p">))</span>
        <span class="n">code_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_states_getter_code</span><span class="p">(</span><span class="n">ode</span><span class="p">))</span>
        <span class="n">code_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_states_setter_code</span><span class="p">(</span><span class="n">ode</span><span class="p">))</span>
        <span class="n">code_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_field_parameters_code</span><span class="p">(</span><span class="n">ode</span><span class="p">))</span>
        <span class="n">code_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_parameters_setter_code</span><span class="p">(</span><span class="n">ode</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;// Gotran generated </span><span class="si">{2}</span><span class="s2"> solver code for the &quot;</span><span class="si">{0}</span><span class="s2">&quot; model</span>

<span class="si">{1}</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">ode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">code_list</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">language</span><span class="p">,</span>
        <span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">OpenCLCodeGenerator</span><span class="p">(</span><span class="n">CCodeGenerator</span><span class="p">):</span>
    <span class="c1"># Class attributes</span>
    <span class="n">language</span> <span class="o">=</span> <span class="s2">&quot;OpenCL&quot;</span>
    <span class="n">indent</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OpenCLCodeGenerator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">use_enum</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s2">&quot;code.body.use_enum cannot be disabled for OpenCL&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">representation</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s2">&quot;array representation of states is unsupported for OpenCL&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">representation</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s2">&quot;array representation of parameters is unsupported for OpenCL&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">default_parameters</span><span class="p">():</span>
        <span class="c1"># Start out with a copy of the global parameters</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">generation</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">use_enum</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">add_offset</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span> <span class="o">=</span> <span class="s2">&quot;d_states&quot;</span>
        <span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">add_field_offset</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">array_name</span> <span class="o">=</span> <span class="s2">&quot;d_parameters&quot;</span>
        <span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">field_array_name</span> <span class="o">=</span> <span class="s2">&quot;d_field_parameters&quot;</span>
        <span class="k">return</span> <span class="n">params</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">wrap_body_with_function_prototype</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">body_lines</span><span class="p">,</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">args</span><span class="p">,</span>
        <span class="n">return_type</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">const</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">kernel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrap a passed body of lines with a function prototype</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_arg</span><span class="p">(</span><span class="n">return_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

        <span class="n">return_type</span> <span class="o">=</span> <span class="n">return_type</span> <span class="ow">or</span> <span class="s2">&quot;void&quot;</span>

        <span class="k">if</span> <span class="n">kernel</span><span class="p">:</span>
            <span class="n">return_type</span> <span class="o">=</span> <span class="s2">&quot;__kernel &quot;</span> <span class="o">+</span> <span class="n">return_type</span>
        <span class="c1"># elif device:</span>
        <span class="c1">#    return_type = &#39;__device__ &#39; + return_type</span>

        <span class="c1"># Call super class function wrapper</span>
        <span class="k">return</span> <span class="n">CCodeGenerator</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
            <span class="n">body_lines</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">args</span><span class="p">,</span>
            <span class="n">return_type</span><span class="p">,</span>
            <span class="n">comment</span><span class="p">,</span>
            <span class="n">const</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp</span><span class="p">):</span>
        <span class="c1"># we must override this so that we can prefix global memory arrays with __global</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span>
        <span class="n">default_arguments</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">params</span><span class="o">.</span><span class="n">default_arguments</span> <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">use_default_arguments</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>

        <span class="n">additional_arguments</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">additional_arguments</span><span class="p">[:]</span>

        <span class="n">skip_result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ret_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">default_arguments</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="o">==</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
                    <span class="n">skip_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span><span class="p">)</span>
                    <span class="n">ret_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;__global </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2">* </span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ret_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;__global const </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2">* </span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">elif</span> <span class="n">arg</span> <span class="o">==</span> <span class="s2">&quot;t&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
                    <span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;Cannot have the same name for the time argument as &quot;</span>
                        <span class="s2">&quot;for a result argument.&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="n">ret_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;const </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;dt&quot;</span> <span class="ow">in</span> <span class="n">additional_arguments</span><span class="p">:</span>
                    <span class="n">additional_arguments</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;dt&quot;</span><span class="p">)</span>
                    <span class="n">ret_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;const </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">arg</span> <span class="o">==</span> <span class="s2">&quot;p&quot;</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">representation</span> <span class="o">!=</span> <span class="s2">&quot;numerals&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">array_name</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
                    <span class="n">skip_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">array_name</span><span class="p">)</span>
                    <span class="n">ret_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;__global </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2">* </span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">array_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ret_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s2">&quot;__global const </span><span class="si">{0}</span><span class="s2">* </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="p">,</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">array_name</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">)</span>

                <span class="n">field_parameters</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="s2">&quot;field_parameters&quot;</span><span class="p">]</span>

                <span class="c1"># If empty</span>
                <span class="c1"># FIXME: Get rid of this by introducing a ListParam type in modelparameters</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_parameters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">field_parameters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">field_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span>
                <span class="p">):</span>
                    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">field_array_name</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
                        <span class="n">skip_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">field_array_name</span><span class="p">)</span>
                        <span class="n">ret_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="s2">&quot;__global </span><span class="si">{0}</span><span class="s2">* </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="p">,</span>
                                <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">field_array_name</span><span class="p">,</span>
                            <span class="p">),</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ret_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="s2">&quot;__global const </span><span class="si">{0}</span><span class="s2">* </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="p">,</span>
                                <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">field_array_name</span><span class="p">,</span>
                            <span class="p">),</span>
                        <span class="p">)</span>

        <span class="n">ret_args</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2">* </span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">additional_arguments</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">in_signature</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">representation</span> <span class="o">!=</span> <span class="s2">&quot;named&quot;</span><span class="p">:</span>
            <span class="n">ret_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;__global </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2">* </span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">array_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">result_name</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skip_result</span><span class="p">:</span>
                <span class="n">ret_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;__global </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2">* </span><span class="si">{</span><span class="n">result_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ret_args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp</span><span class="p">):</span>
        <span class="n">check_arg</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">CodeComponent</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span>
        <span class="n">default_arguments</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">params</span><span class="o">.</span><span class="n">default_arguments</span> <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">use_default_arguments</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>

        <span class="n">field_parameters</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="s2">&quot;field_parameters&quot;</span><span class="p">]</span>

        <span class="c1"># If empty</span>
        <span class="c1"># FIXME: Get rid of this by introducing a ListParam type in modelparameters</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_parameters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">field_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">field_parameters</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># state_offset = params[&quot;states&quot;][&quot;add_offset&quot;]</span>
        <span class="n">parameter_offset</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="s2">&quot;add_offset&quot;</span><span class="p">]</span>
        <span class="n">field_parameter_offset</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="s2">&quot;add_field_offset&quot;</span><span class="p">]</span>

        <span class="c1"># Check if comp defines used_states if not use the root components</span>
        <span class="c1"># full_states attribute</span>
        <span class="c1"># FIXME: No need for full_states here...</span>
        <span class="n">full_states</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">full_states</span>
        <span class="n">used_states</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">used_states</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="s2">&quot;used_states&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">full_states</span>

        <span class="n">used_parameters</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">comp</span><span class="o">.</span><span class="n">used_parameters</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="s2">&quot;used_parameters&quot;</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">parameters</span>
        <span class="p">)</span>
        <span class="n">all_parameters</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">parameters</span>

        <span class="n">field_parameters</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">all_parameters</span> <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">field_parameters</span>
        <span class="p">]</span>

        <span class="c1"># Start building body</span>
        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">add_state_obj</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">enum_val</span><span class="p">,</span> <span class="n">array_name</span><span class="p">):</span>
            <span class="n">index_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;n_nodes * </span><span class="si">{</span><span class="n">enum_val</span><span class="si">}</span><span class="s2"> + thread_ind&quot;</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;const </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">array_name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">index_str</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">def</span> <span class="nf">add_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">array_name</span><span class="p">,</span> <span class="n">add_offset</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">array_name</span><span class="si">}</span><span class="s2">_offset + &quot;</span> <span class="k">if</span> <span class="n">add_offset</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;const </span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2"> = </span><span class="si">{2}</span><span class="s2">[</span><span class="si">{3}{4}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">obj_name</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span>
                    <span class="n">array_name</span><span class="p">,</span>
                    <span class="n">offset</span><span class="p">,</span>
                    <span class="n">i</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;s&quot;</span> <span class="ow">in</span> <span class="n">default_arguments</span> <span class="ow">and</span> <span class="n">used_states</span><span class="p">:</span>

            <span class="c1"># Generate state assign code</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">representation</span> <span class="o">==</span> <span class="s2">&quot;named&quot;</span><span class="p">:</span>

                <span class="n">states_name</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;// Assign states&quot;</span><span class="p">)</span>

                <span class="c1"># If all states are used</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">full_states</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_states</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="c1"># add_obj(state, i, states_name, state_offset)</span>
                    <span class="c1"># add_obj(state, self._state_enum_val(state), states_name, state_offset)</span>
                    <span class="n">add_state_obj</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_enum_val</span><span class="p">(</span><span class="n">state</span><span class="p">),</span> <span class="n">states_name</span><span class="p">)</span>

        <span class="c1"># Add parameters code if not numerals</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="s2">&quot;p&quot;</span> <span class="ow">in</span> <span class="n">default_arguments</span>
            <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">representation</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;named&quot;</span><span class="p">,</span> <span class="s2">&quot;array&quot;</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">used_parameters</span>
        <span class="p">):</span>

            <span class="c1"># Generate parameters assign code</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">representation</span> <span class="o">==</span> <span class="s2">&quot;named&quot;</span><span class="p">:</span>

                <span class="n">parameters_name</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">array_name</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;// Assign parameters&quot;</span><span class="p">)</span>

                <span class="c1"># If all states are used</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_parameters</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">param</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_parameters</span> <span class="ow">or</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">field_parameters</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="c1"># add_obj(param, i, parameters_name, parameter_offset)</span>
                    <span class="n">add_obj</span><span class="p">(</span>
                        <span class="n">param</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_parameter_enum_val</span><span class="p">(</span><span class="n">param</span><span class="p">),</span>
                        <span class="n">parameters_name</span><span class="p">,</span>
                        <span class="n">parameter_offset</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="n">field_parameters_name</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">field_array_name</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">field_parameters</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">param</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_parameters</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">add_obj</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">field_parameters_name</span><span class="p">,</span> <span class="n">field_parameter_offset</span><span class="p">)</span>

        <span class="c1"># If using an array for the body variables and b is not passed as argument</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">representation</span> <span class="o">!=</span> <span class="s2">&quot;named&quot;</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">in_signature</span>
            <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">array_name</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">shapes</span>
        <span class="p">):</span>

            <span class="n">body_name</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">array_name</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;// Body array </span><span class="si">{</span><span class="n">body_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">body_name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">comp</span><span class="o">.</span><span class="n">shapes</span><span class="p">[</span><span class="n">body_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">body_lines</span>

    <span class="k">def</span> <span class="nf">init_states_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate code for setting initial condition</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">array_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span>
        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;const unsigned int thread_ind = get_global_id(0)&quot;</span><span class="p">]</span>
        <span class="n">n_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">n_nodes</span>
        <span class="k">if</span> <span class="n">n_nodes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;if (thread_ind &gt;= n_nodes) return; &quot;</span> <span class="s2">&quot;// number of nodes exceeded&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="c1"># body_lines.append(&quot;const int {0}_offset = thread_ind*{1}&quot;.format(\</span>
        <span class="c1">#    array_name, ode.num_full_states))</span>

        <span class="c1"># Main body</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">[n_nodes * </span><span class="si">{1}</span><span class="s2"> + thread_ind] = </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">array_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state_enum_val</span><span class="p">(</span><span class="n">state</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_float_literal_str</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">init</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ode</span><span class="o">.</span><span class="n">full_states</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Add function prototype</span>
        <span class="n">init_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
            <span class="n">body_lines</span><span class="p">,</span>
            <span class="s2">&quot;init_state_values&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;__global </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2"> *</span><span class="si">{</span><span class="n">array_name</span><span class="si">}</span><span class="s2">, const unsigned int n_nodes&quot;</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;Init state values&quot;</span><span class="p">,</span>
            <span class="n">kernel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">init_function</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">init_parameters_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate code for setting parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># FIXME: The OpenCL program cannot contain CPU/host functions,</span>
        <span class="c1"># so we must leave out the parameter initialisation code</span>
        <span class="k">return</span> <span class="s2">&quot;// cannot generate init_parameters function for OpenCL&quot;</span>

    <span class="k">def</span> <span class="nf">state_name_to_index_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c1"># FIXME: The OpenCL program cannot contain CPU/host functions,</span>
        <span class="c1"># so we must leave out the parameter initialisation code</span>
        <span class="k">return</span> <span class="s2">&quot;// cannot generate state_index function for OpenCL&quot;</span>

    <span class="k">def</span> <span class="nf">param_name_to_index_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c1"># FIXME: The OpenCL program cannot contain CPU/host functions,</span>
        <span class="c1"># so we must leave out the parameter initialisation code</span>
        <span class="k">return</span> <span class="s2">&quot;// cannot generate parameter_index function for OpenCL&quot;</span>

    <span class="k">def</span> <span class="nf">init_field_parameters_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate code for initialising field parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">field_parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">field_parameters</span>

        <span class="c1"># If empty</span>
        <span class="c1"># FIXME: Get rid of this by introducing a ListParam type in modelparameters</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_parameters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">field_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">field_parameters</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">array_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">array_name</span>
        <span class="n">base_array_name</span> <span class="o">=</span> <span class="n">array_name</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="k">if</span> <span class="n">array_name</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;d_&quot;</span> <span class="k">else</span> <span class="n">array_name</span>
        <span class="n">field_array_name</span> <span class="o">=</span> <span class="s2">&quot;d_field_&quot;</span> <span class="o">+</span> <span class="n">base_array_name</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="n">ode</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">parameter_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">]</span>
        <span class="n">field_parameter_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">parameter_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">field_parameters</span><span class="p">]</span>
        <span class="n">num_field_parameters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_parameters</span><span class="p">)</span>

        <span class="n">body_lines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">num_field_parameters</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;const int thread_ind = blockIdx.x*blockDim.x + threadIdx.x&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">n_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">n_nodes</span>
            <span class="k">if</span> <span class="n">n_nodes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;if (thread_ind &gt;= </span><span class="si">{</span><span class="n">n_nodes</span><span class="si">}</span><span class="s2">) return; // number of nodes exceeded&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;const int field_</span><span class="si">{0}</span><span class="s2">_offset = thread_ind*</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">base_array_name</span><span class="p">,</span>
                    <span class="n">num_field_parameters</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># Main body</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">[field_</span><span class="si">{1}</span><span class="s2">_offset + </span><span class="si">{2}</span><span class="s2">] = </span><span class="si">{3}</span><span class="s2">; //</span><span class="si">{4}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">field_array_name</span><span class="p">,</span>
                <span class="n">base_array_name</span><span class="p">,</span>
                <span class="n">i</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_float_literal_str</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="n">field_parameter_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">init</span><span class="p">),</span>
                <span class="n">field_parameter</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">field_parameter</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">field_parameters</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Add function prototype</span>
        <span class="n">init_fparam_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
            <span class="n">body_lines</span><span class="p">,</span>
            <span class="s2">&quot;init_field_parameters&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2"> *</span><span class="si">{</span><span class="n">field_array_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;Initialize field parameters&quot;</span><span class="p">,</span>
            <span class="n">kernel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">init_fparam_func</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">field_parameters_setter_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c1"># FIXME: Implement!</span>
        <span class="c1"># This is actually not needed</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">field_states_getter_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate code for field state getter</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">field_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">field_states</span>

        <span class="c1"># If empty</span>
        <span class="c1"># FIXME: Get rid of this by introducing a ListParam type in modelparameters</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_states</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">field_states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">field_states</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">array_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span>
        <span class="n">base_array_name</span> <span class="o">=</span> <span class="n">array_name</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="k">if</span> <span class="n">array_name</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;d_&quot;</span> <span class="k">else</span> <span class="n">array_name</span>
        <span class="n">field_array_name</span> <span class="o">=</span> <span class="s2">&quot;h_field_&quot;</span> <span class="o">+</span> <span class="n">base_array_name</span>

        <span class="n">states</span> <span class="o">=</span> <span class="n">ode</span><span class="o">.</span><span class="n">full_states</span>
        <span class="c1"># FIXME: Check that the state is really a state</span>
        <span class="n">field_states</span> <span class="o">=</span> <span class="p">[</span><span class="n">state</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span> <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">field_states</span><span class="p">]</span>

        <span class="n">num_field_states</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_states</span><span class="p">)</span>
        <span class="n">array_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span>

        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">num_field_states</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;const int thread_ind = blockIdx.x*blockDim.x + threadIdx.x&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">n_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">n_nodes</span>
            <span class="k">if</span> <span class="n">n_nodes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;if (thread_ind &gt;= </span><span class="si">{</span><span class="n">n_nodes</span><span class="si">}</span><span class="s2">) return; // number of nodes exceeded&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;const int </span><span class="si">{</span><span class="n">base_array_name</span><span class="si">}</span><span class="s2">_offset = thread_ind*</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">states</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;const int field_</span><span class="si">{0}</span><span class="s2">_offset = thread_ind*</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">base_array_name</span><span class="p">,</span>
                    <span class="n">num_field_states</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># Main body</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">[field_</span><span class="si">{2}</span><span class="s2">_offset + </span><span class="si">{3}</span><span class="s2">] = &quot;</span>
            <span class="s2">&quot;</span><span class="si">{1}</span><span class="s2">[</span><span class="si">{2}</span><span class="s2">_offset + </span><span class="si">{4}</span><span class="s2">]; //</span><span class="si">{5}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">field_array_name</span><span class="p">,</span>
                <span class="n">array_name</span><span class="p">,</span>
                <span class="n">base_array_name</span><span class="p">,</span>
                <span class="n">i</span><span class="p">,</span>
                <span class="n">states</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">state</span><span class="p">),</span>
                <span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">field_states</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Add function prototype</span>
        <span class="n">getter_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
            <span class="n">body_lines</span><span class="p">,</span>
            <span class="s2">&quot;get_field_states&quot;</span><span class="p">,</span>
            <span class="s2">&quot;__global const </span><span class="si">{0}</span><span class="s2"> *</span><span class="si">{1}</span><span class="s2">, __global </span><span class="si">{0}</span><span class="s2"> *</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="p">,</span>
                <span class="n">array_name</span><span class="p">,</span>
                <span class="n">field_array_name</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;Get field states&quot;</span><span class="p">,</span>
            <span class="n">kernel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">getter_func</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">field_states_setter_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate code for field state setter</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">field_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">field_states</span>

        <span class="c1"># If empty</span>
        <span class="c1"># FIXME: Get rid of this by introducing a ListParam type in modelparameters</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_states</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">field_states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">field_states</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">array_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span>
        <span class="n">base_array_name</span> <span class="o">=</span> <span class="n">array_name</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="k">if</span> <span class="n">array_name</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;d_&quot;</span> <span class="k">else</span> <span class="n">array_name</span>
        <span class="n">field_array_name</span> <span class="o">=</span> <span class="s2">&quot;h_field_&quot;</span> <span class="o">+</span> <span class="n">base_array_name</span>

        <span class="n">states</span> <span class="o">=</span> <span class="n">ode</span><span class="o">.</span><span class="n">full_states</span>
        <span class="c1"># FIXME: Check that the state is really a state</span>
        <span class="n">field_states</span> <span class="o">=</span> <span class="p">[</span><span class="n">state</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span> <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">field_states</span><span class="p">]</span>

        <span class="n">num_field_states</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_states</span><span class="p">)</span>

        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">num_field_states</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;const int thread_ind = blockIdx.x*blockDim.x + threadIdx.x&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">n_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">n_nodes</span>
            <span class="k">if</span> <span class="n">n_nodes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;if (thread_ind &gt;= </span><span class="si">{</span><span class="n">n_nodes</span><span class="si">}</span><span class="s2">) return; // number of nodes exceeded&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;const int </span><span class="si">{</span><span class="n">base_array_name</span><span class="si">}</span><span class="s2">_offset = thread_ind*</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">states</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;const int field_</span><span class="si">{0}</span><span class="s2">_offset = thread_ind*</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">base_array_name</span><span class="p">,</span>
                    <span class="n">num_field_states</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># Main body</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">[</span><span class="si">{2}</span><span class="s2">_offset + </span><span class="si">{3}</span><span class="s2">] = &quot;</span>
            <span class="s2">&quot;</span><span class="si">{1}</span><span class="s2">[field_</span><span class="si">{2}</span><span class="s2">_offset + </span><span class="si">{4}</span><span class="s2">]; //</span><span class="si">{5}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">array_name</span><span class="p">,</span>
                <span class="n">field_array_name</span><span class="p">,</span>
                <span class="n">base_array_name</span><span class="p">,</span>
                <span class="n">states</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">state</span><span class="p">),</span>
                <span class="n">i</span><span class="p">,</span>
                <span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">field_states</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Add function prototype</span>
        <span class="n">setter_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
            <span class="n">body_lines</span><span class="p">,</span>
            <span class="s2">&quot;set_field_states&quot;</span><span class="p">,</span>
            <span class="s2">&quot;__global const </span><span class="si">{0}</span><span class="s2"> *</span><span class="si">{1}</span><span class="s2">, __global </span><span class="si">{0}</span><span class="s2"> *</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="p">,</span>
                <span class="n">field_array_name</span><span class="p">,</span>
                <span class="n">array_name</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;Set field states&quot;</span><span class="p">,</span>
            <span class="n">kernel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">setter_func</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">function_code</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">comp</span><span class="p">,</span>
        <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">default_arguments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">include_signature</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">return_body_lines</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span>
        <span class="n">field_parameters</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">field_parameters</span>

        <span class="c1"># If empty</span>
        <span class="c1"># FIXME: Get rid of this by introducing a ListParam type in modelparameters</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_parameters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">field_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">field_parameters</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">default_arguments</span> <span class="o">=</span> <span class="n">default_arguments</span> <span class="ow">or</span> <span class="n">params</span><span class="o">.</span><span class="n">default_arguments</span>

        <span class="n">check_arg</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">CodeComponent</span><span class="p">)</span>
        <span class="n">check_kwarg</span><span class="p">(</span><span class="n">default_arguments</span><span class="p">,</span> <span class="s2">&quot;default_arguments&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">check_kwarg</span><span class="p">(</span><span class="n">indent</span><span class="p">,</span> <span class="s2">&quot;indent&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>

        <span class="n">field_parameter_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">field_array_name</span>

        <span class="c1"># Initialization</span>
        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;const unsigned int thread_ind = get_global_id(0)&quot;</span><span class="p">]</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;if (thread_ind &gt;= n_nodes) return; &quot;</span> <span class="s2">&quot;// number of nodes exceeded&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_parameters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;const int </span><span class="si">{0}</span><span class="s2">_offset = thread_ind*</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">field_parameter_name</span><span class="p">,</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">field_parameters</span><span class="p">),</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="n">body_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_init_arguments</span><span class="p">(</span><span class="n">comp</span><span class="p">))</span>

        <span class="c1"># If named body representation we need to check for duplicates</span>
        <span class="n">duplicates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">declared_duplicates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">representation</span> <span class="o">==</span> <span class="s2">&quot;named&quot;</span><span class="p">:</span>
            <span class="n">collected_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">body_expressions</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
                    <span class="n">expr</span><span class="p">,</span>
                    <span class="n">IndexedExpression</span><span class="p">,</span>
                <span class="p">):</span>
                    <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">collected_names</span><span class="p">:</span>
                        <span class="n">duplicates</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">collected_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Iterate over any body needed to define the dy</span>
        <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">body_expressions</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Comment</span><span class="p">):</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;// &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">IndexedExpression</span><span class="p">)</span>
                <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">StateIndexedExpression</span><span class="p">)</span>
                <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ParameterIndexedExpression</span><span class="p">)</span>
            <span class="p">):</span>

                <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">][</span><span class="s2">&quot;use_enum&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">StateIndexedExpression</span><span class="p">):</span>
                        <span class="n">state_enum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_enum_val</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
                        <span class="n">index_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;n_nodes * </span><span class="si">{</span><span class="n">state_enum</span><span class="si">}</span><span class="s2"> + thread_ind&quot;</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">expr</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">index_str</span><span class="si">}</span><span class="s2">]&quot;</span>
                        <span class="c1"># name = &quot;{0}[{1}]&quot;.format(expr.basename,self._state_enum_val(expr.state))</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ParameterIndexedExpression</span><span class="p">):</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">[</span><span class="si">{1}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">expr</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_parameter_enum_val</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">parameter</span><span class="p">),</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;Cannot enumerate expression </span><span class="si">{0}</span><span class="s2"> of type </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">expr</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span>
                                <span class="nb">type</span><span class="p">(</span><span class="n">expr</span><span class="p">),</span>
                            <span class="p">),</span>
                        <span class="p">)</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">expr</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">expr</span><span class="o">.</span><span class="n">enum</span><span class="si">}</span><span class="s2">]&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">obj_name</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">declared_duplicates</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">obj_name</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">declared_duplicates</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">obj_name</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;const </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">float_type</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">obj_name</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_code</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">return_body_lines</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">body_lines</span>

        <span class="k">if</span> <span class="n">include_signature</span><span class="p">:</span>
            <span class="c1"># Add function prototype</span>
            <span class="n">body_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
                <span class="n">body_lines</span><span class="p">,</span>
                <span class="n">comp</span><span class="o">.</span><span class="n">function_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, const unsigned int n_nodes&quot;</span><span class="p">,</span>
                <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">comp</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="n">kernel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">body_lines</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">module_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">monitored</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">code_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">code_dict</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">monitored</span><span class="o">=</span><span class="n">monitored</span><span class="p">,</span> <span class="n">include_index_map</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="n">code_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_states_getter_code</span><span class="p">(</span><span class="n">ode</span><span class="p">))</span>
        <span class="n">code_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_states_setter_code</span><span class="p">(</span><span class="n">ode</span><span class="p">))</span>
        <span class="n">code_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_parameters_setter_code</span><span class="p">(</span><span class="n">ode</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;// Gotran generated OpenCL code for the &quot;</span><span class="si">{0}</span><span class="s2">&quot; model</span>

<span class="si">{1}</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">ode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">code_list</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">solver_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">solver_type</span><span class="p">):</span>
        <span class="n">code_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">code_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_code</span><span class="p">(</span>
                <span class="n">get_solver_fn</span><span class="p">(</span><span class="n">solver_type</span><span class="p">)(</span><span class="n">ode</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">code_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_states_code</span><span class="p">(</span><span class="n">ode</span><span class="p">))</span>
        <span class="n">code_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_states_getter_code</span><span class="p">(</span><span class="n">ode</span><span class="p">))</span>
        <span class="n">code_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_states_setter_code</span><span class="p">(</span><span class="n">ode</span><span class="p">))</span>
        <span class="n">code_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_field_parameters_code</span><span class="p">(</span><span class="n">ode</span><span class="p">))</span>
        <span class="n">code_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_parameters_setter_code</span><span class="p">(</span><span class="n">ode</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;// Gotran generated OpenCL solver code for the &quot;</span><span class="si">{0}</span><span class="s2">&quot; model</span>

<span class="si">{1}</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">ode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">code_list</span><span class="p">),</span>
        <span class="p">)</span>


<div class="viewcode-block" id="MatlabCodeGenerator"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.MatlabCodeGenerator">[docs]</a><span class="k">class</span> <span class="nc">MatlabCodeGenerator</span><span class="p">(</span><span class="n">BaseCodeGenerator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Matlab Code generator</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Class attributes</span>
    <span class="n">language</span> <span class="o">=</span> <span class="s2">&quot;Matlab&quot;</span>
    <span class="n">line_ending</span> <span class="o">=</span> <span class="s2">&quot;;&quot;</span>
    <span class="n">closure_start</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">closure_end</span> <span class="o">=</span> <span class="s2">&quot;end&quot;</span>
    <span class="n">line_cont</span> <span class="o">=</span> <span class="s2">&quot;...&quot;</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;%&quot;</span>
    <span class="n">index</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="n">indent</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">indent_str</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
    <span class="n">to_code</span> <span class="o">=</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">matlabcode</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="MatlabCodeGenerator.default_parameters"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.MatlabCodeGenerator.default_parameters">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">default_parameters</span><span class="p">():</span>
        <span class="c1"># Start out with a copy of the global parameters</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">generation</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">index_format</span> <span class="o">=</span> <span class="s2">&quot;()&quot;</span>
        <span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">index_offset</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">flatten</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">params</span></div>

<div class="viewcode-block" id="MatlabCodeGenerator.wrap_body_with_function_prototype"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.MatlabCodeGenerator.wrap_body_with_function_prototype">[docs]</a>    <span class="k">def</span> <span class="nf">wrap_body_with_function_prototype</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">body_lines</span><span class="p">,</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">args</span><span class="p">,</span>
        <span class="n">return_args</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrap a passed body of lines with a function prototype</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_arg</span><span class="p">(</span><span class="n">body_lines</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="n">check_arg</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">check_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">check_arg</span><span class="p">(</span><span class="n">return_args</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">check_arg</span><span class="p">(</span><span class="n">comment</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">return_args</span><span class="p">:</span>
            <span class="n">return_args</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">return_args</span><span class="si">}</span><span class="s2">] = &quot;</span>

        <span class="n">prototype</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;function </span><span class="si">{</span><span class="n">return_args</span><span class="si">}{</span><span class="n">name</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">]</span>
        <span class="n">body</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Wrap comment if any</span>
        <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comment</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">body</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;% &quot;</span> <span class="o">+</span> <span class="n">com</span> <span class="k">for</span> <span class="n">com</span> <span class="ow">in</span> <span class="n">comment</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;% &quot;</span> <span class="o">+</span> <span class="n">comment</span><span class="p">)</span>

        <span class="c1"># Extend the body with body lines</span>
        <span class="n">body</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">body_lines</span><span class="p">)</span>

        <span class="c1"># Append body to prototyp</span>
        <span class="n">prototype</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">prototype</span></div>

<div class="viewcode-block" id="MatlabCodeGenerator.args"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.MatlabCodeGenerator.args">[docs]</a>    <span class="k">def</span> <span class="nf">args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build argument str</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span>
        <span class="n">default_arguments</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">params</span><span class="o">.</span><span class="n">default_arguments</span> <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">use_default_arguments</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>

        <span class="n">input_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">default_arguments</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="o">==</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span>
                <span class="n">input_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">arg</span> <span class="o">==</span> <span class="s2">&quot;t&quot;</span><span class="p">:</span>
                <span class="n">input_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">arg</span> <span class="o">==</span> <span class="s2">&quot;p&quot;</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">representation</span> <span class="o">!=</span> <span class="s2">&quot;numerals&quot;</span><span class="p">:</span>
                <span class="n">input_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">array_name</span><span class="p">)</span>

        <span class="n">input_args</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">additional_arguments</span><span class="p">)</span>

        <span class="c1"># Arguments with default (None) values</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">in_signature</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">representation</span> <span class="o">!=</span> <span class="s2">&quot;named&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

        <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">results</span><span class="p">),</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_args</span><span class="p">)</span></div>

<div class="viewcode-block" id="MatlabCodeGenerator.code_dict"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.MatlabCodeGenerator.code_dict">[docs]</a>    <span class="k">def</span> <span class="nf">code_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">monitored</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_init</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="n">code_dict</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">MatlabCodeGenerator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">code_dict</span><span class="p">(</span>
            <span class="n">ode</span><span class="p">,</span>
            <span class="n">monitored</span><span class="o">=</span><span class="n">monitored</span><span class="p">,</span>
            <span class="n">include_init</span><span class="o">=</span><span class="n">include_init</span><span class="p">,</span>
            <span class="n">include_index_map</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">monitored</span><span class="p">:</span>
            <span class="n">code_dict</span><span class="p">[</span><span class="s2">&quot;monitored_names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitored_names_code</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">monitored</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">code_dict</span></div>

<div class="viewcode-block" id="MatlabCodeGenerator.init_parameters_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.MatlabCodeGenerator.init_parameters_code">[docs]</a>    <span class="k">def</span> <span class="nf">init_parameters_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create code for getting default parameter values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Start building body</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;if nargout &lt; 1 || nargout &gt; 2&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;error(&#39;Expected 1-2 output arguments.&#39;)&quot;</span><span class="p">])</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;% --- Default parameters values --- &quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;parameters = zeros(</span><span class="si">{</span><span class="n">ode</span><span class="o">.</span><span class="n">num_parameters</span><span class="si">}</span><span class="s2">, 1)&quot;</span><span class="p">)</span>

        <span class="n">parameter_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>
        <span class="n">parameter_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;% --- Parameter names --- &quot;</span><span class="p">)</span>
        <span class="n">parameter_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;parameter_names = cell(</span><span class="si">{</span><span class="n">ode</span><span class="o">.</span><span class="n">num_parameters</span><span class="si">}</span><span class="s2">, 1)&quot;</span><span class="p">)</span>

        <span class="n">present_param_component</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ode</span><span class="o">.</span><span class="n">parameters</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">present_param_component</span> <span class="o">!=</span> <span class="n">ode</span><span class="o">.</span><span class="n">object_component</span><span class="p">[</span><span class="n">param</span><span class="p">]:</span>
                <span class="n">present_param_component</span> <span class="o">=</span> <span class="n">ode</span><span class="o">.</span><span class="n">object_component</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>

                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;% --- </span><span class="si">{</span><span class="n">present_param_component</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>

                <span class="n">parameter_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">parameter_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;% --- </span><span class="si">{</span><span class="n">present_param_component</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>

            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;parameters(</span><span class="si">{</span><span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">) = </span><span class="si">{</span><span class="n">param</span><span class="o">.</span><span class="n">init</span><span class="si">}</span><span class="s2">; % </span><span class="si">{</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">parameter_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;parameter_names</span><span class="se">{{</span><span class="si">{</span><span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="se">}}</span><span class="s2"> = &#39;</span><span class="si">{</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="n">parameter_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;varargout(1) = </span><span class="si">{parameter_names}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;if nargout == 2&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parameter_names</span><span class="p">)</span>

        <span class="n">body_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
            <span class="n">body_lines</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ode</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_init_parameters&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;parameters, varargout&quot;</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="sa">f</span><span class="s2">&quot;% Default parameter values for ODE model: </span><span class="si">{</span><span class="n">ode</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;% ----------------------------------------</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ode</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">*</span> <span class="s1">&#39;-&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;%&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;% parameters = </span><span class="si">{</span><span class="n">ode</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_init_parameters();&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;% [parameters, parameters_names] = </span><span class="si">{</span><span class="n">ode</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_init_parameter();&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">body_lines</span><span class="p">))</span></div>

<div class="viewcode-block" id="MatlabCodeGenerator.init_states_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.MatlabCodeGenerator.init_states_code">[docs]</a>    <span class="k">def</span> <span class="nf">init_states_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

        <span class="c1"># Default initial values and state names</span>
        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;% --- Default initial state values --- &quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;states = zeros(</span><span class="si">{</span><span class="n">ode</span><span class="o">.</span><span class="n">num_full_states</span><span class="si">}</span><span class="s2">, 1)&quot;</span><span class="p">)</span>

        <span class="n">state_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>
        <span class="n">state_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;% --- State names --- &quot;</span><span class="p">)</span>
        <span class="n">state_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;state_names = cell(</span><span class="si">{</span><span class="n">ode</span><span class="o">.</span><span class="n">num_full_states</span><span class="si">}</span><span class="s2">, 1)&quot;</span><span class="p">)</span>

        <span class="n">present_state_component</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ode</span><span class="o">.</span><span class="n">full_states</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">present_state_component</span> <span class="o">!=</span> <span class="n">ode</span><span class="o">.</span><span class="n">object_component</span><span class="p">[</span><span class="n">state</span><span class="p">]:</span>
                <span class="n">present_state_component</span> <span class="o">=</span> <span class="n">ode</span><span class="o">.</span><span class="n">object_component</span><span class="p">[</span><span class="n">state</span><span class="p">]</span>

                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;% --- </span><span class="si">{</span><span class="n">present_state_component</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>

                <span class="n">state_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">state_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;% --- </span><span class="si">{</span><span class="n">present_state_component</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>

            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;states(</span><span class="si">{</span><span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">) = </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">init</span><span class="si">}</span><span class="s2">; % </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">state_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;state_names</span><span class="se">{{</span><span class="si">{</span><span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="se">}}</span><span class="s2"> = &#39;</span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="n">state_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;varargout(1) = </span><span class="si">{state_names}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Add bodys to code</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;if nargout == 2&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state_names</span><span class="p">)</span>

        <span class="n">body_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
            <span class="n">body_lines</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ode</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_init_states&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;states, varargout&quot;</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="sa">f</span><span class="s2">&quot;% Default state values for ODE model: </span><span class="si">{</span><span class="n">ode</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;% ------------------------------------</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ode</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">*</span> <span class="s1">&#39;-&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;%&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;% states = </span><span class="si">{</span><span class="n">ode</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_init_states();&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;% [states, states_names] = </span><span class="si">{</span><span class="n">ode</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_init_states();&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">body_lines</span><span class="p">))</span></div>

<div class="viewcode-block" id="MatlabCodeGenerator.monitored_names_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.MatlabCodeGenerator.monitored_names_code">[docs]</a>    <span class="k">def</span> <span class="nf">monitored_names_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">monitored</span><span class="p">):</span>
        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;% --- Monitored names --- &quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;monitored_names = cell(</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">monitored</span><span class="p">)</span><span class="si">}</span><span class="s2">, 1)&quot;</span><span class="p">)</span>

        <span class="n">present_monitor_component</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">monitor</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">monitored</span><span class="p">):</span>

            <span class="n">obj</span> <span class="o">=</span> <span class="n">ode</span><span class="o">.</span><span class="n">present_ode_objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">monitor</span><span class="p">)</span>
            <span class="n">component</span> <span class="o">=</span> <span class="n">ode</span><span class="o">.</span><span class="n">object_component</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">present_monitor_component</span> <span class="o">!=</span> <span class="n">component</span><span class="p">:</span>
                <span class="n">present_monitor_component</span> <span class="o">=</span> <span class="n">component</span>

                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;% --- </span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>

            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;monitored_names</span><span class="se">{{</span><span class="si">{</span><span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="se">}}</span><span class="s2"> = &#39;</span><span class="si">{</span><span class="n">monitor</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="n">body_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
            <span class="n">body_lines</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ode</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_monitored_names&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;monitored_names&quot;</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="sa">f</span><span class="s2">&quot;% Monitored value names for ODE model: </span><span class="si">{</span><span class="n">ode</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;% ---------------------- --------------</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ode</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">*</span> <span class="s1">&#39;-&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;%&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;% monitored_names = </span><span class="si">{</span><span class="n">ode</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_monitored_names();&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">body_lines</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_init_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp</span><span class="p">):</span>

        <span class="n">check_arg</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">CodeComponent</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span>

        <span class="n">default_arguments</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">params</span><span class="o">.</span><span class="n">default_arguments</span> <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">use_default_arguments</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Check if comp defines used_states if not use the root components</span>
        <span class="c1"># full_states attribute</span>
        <span class="c1"># FIXME: No need for full_states here...</span>
        <span class="n">used_states</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">comp</span><span class="o">.</span><span class="n">used_states</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="s2">&quot;used_states&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">full_states</span>
        <span class="p">)</span>

        <span class="n">used_parameters</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">comp</span><span class="o">.</span><span class="n">used_parameters</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="s2">&quot;used_parameters&quot;</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">parameters</span>
        <span class="p">)</span>

        <span class="n">num_states</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">num_full_states</span>
        <span class="n">num_parameters</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">num_parameters</span>

        <span class="c1"># Start building body</span>
        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s2">&quot;s&quot;</span> <span class="ow">in</span> <span class="n">default_arguments</span> <span class="ow">and</span> <span class="n">used_states</span><span class="p">:</span>

            <span class="n">states_name</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;% Assign states&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;if length(</span><span class="si">{</span><span class="n">states_name</span><span class="si">}</span><span class="s2">)~=</span><span class="si">{</span><span class="n">num_states</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;error(&#39;Expected the </span><span class="si">{0}</span><span class="s2"> array to be of &quot;</span>
                    <span class="s2">&quot;size </span><span class="si">{1}</span><span class="s2">.&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">states_name</span><span class="p">,</span> <span class="n">num_states</span><span class="p">),</span>
                <span class="p">],</span>
            <span class="p">)</span>

            <span class="c1"># Generate state assign code</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">representation</span> <span class="o">==</span> <span class="s2">&quot;named&quot;</span><span class="p">:</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">states_name</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">)&quot;</span>
                        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">full_states</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">used_states</span>
                    <span class="p">),</span>
                <span class="p">)</span>

        <span class="c1"># Add parameters code if not numerals</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="s2">&quot;p&quot;</span> <span class="ow">in</span> <span class="n">default_arguments</span>
            <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">representation</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;named&quot;</span><span class="p">,</span> <span class="s2">&quot;array&quot;</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">used_parameters</span>
        <span class="p">):</span>

            <span class="n">parameters_name</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">array_name</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;% Assign parameters&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;if length(</span><span class="si">{</span><span class="n">parameters_name</span><span class="si">}</span><span class="s2">)~=</span><span class="si">{</span><span class="n">num_parameters</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;error(&#39;Expected the </span><span class="si">{0}</span><span class="s2"> array to be of &quot;</span>
                    <span class="s2">&quot;size </span><span class="si">{1}</span><span class="s2">.&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parameters_name</span><span class="p">,</span> <span class="n">num_parameters</span><span class="p">),</span>
                <span class="p">],</span>
            <span class="p">)</span>

            <span class="c1"># Generate parameters assign code</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">representation</span> <span class="o">==</span> <span class="s2">&quot;named&quot;</span><span class="p">:</span>

                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">parameters_name</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">)&quot;</span>
                        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">used_parameters</span>
                    <span class="p">),</span>
                <span class="p">)</span>

        <span class="c1"># If using an array for the body variables</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">representation</span> <span class="o">!=</span> <span class="s2">&quot;named&quot;</span>
            <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">array_name</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">shapes</span>
        <span class="p">):</span>

            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Using non-named representation of &quot;</span>
                <span class="s2">&quot;the body arguments is not implemented.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># body_name = params.body.array_name</span>
            <span class="c1"># body_lines.append(&quot;&quot;)</span>
            <span class="c1"># body_lines.append(&quot;% Body array {0}&quot;.format(body_name))</span>
            <span class="c1">#</span>
            <span class="c1">## If passing the body argument to the method</span>
            <span class="c1"># if  params.body.in_signature:</span>
            <span class="c1">#    body_lines.append(&quot;if {0} is None:&quot;.format(body_name))</span>
            <span class="c1">#    body_lines.append([&quot;{0} = np.zeros({1}, dtype=np.{2})&quot;.format(\</span>
            <span class="c1">#        body_name, comp.shapes[body_name], self.float_type)])</span>
            <span class="c1">#    body_lines.append(&quot;else:&quot;.format(body_name))</span>
            <span class="c1">#    body_lines.append([&quot;assert isinstance({0}, np.ndarray) and &quot;\</span>
            <span class="c1">#                       &quot;{1}.shape=={2}&quot;.format(\</span>
            <span class="c1">#                body_name, body_name, comp.shapes[body_name])])</span>
            <span class="c1"># else:</span>
            <span class="c1">#    body_lines.append(&quot;{0} = np.zeros({1}, dtype=np.{2})&quot;.format(\</span>
            <span class="c1">#        body_name, comp.shapes[body_name], self.float_type))</span>

        <span class="c1"># If initelizing results</span>
        <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;% Init return args&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">result_name</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">shapes</span><span class="p">[</span><span class="n">result_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">flatten</span><span class="p">:</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="mi">1</span><span class="p">),)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result_name</span><span class="si">}</span><span class="s2"> = zeros</span><span class="si">{</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">body_lines</span>

<div class="viewcode-block" id="MatlabCodeGenerator.function_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.MatlabCodeGenerator.function_code">[docs]</a>    <span class="k">def</span> <span class="nf">function_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

        <span class="n">check_arg</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">CodeComponent</span><span class="p">)</span>
        <span class="n">check_kwarg</span><span class="p">(</span><span class="n">indent</span><span class="p">,</span> <span class="s2">&quot;indent&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>

        <span class="n">body_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_arguments</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>

        <span class="c1"># Iterate over any body</span>
        <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">body_expressions</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Comment</span><span class="p">):</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;% &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_code</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">expr</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="c1"># Add function prototype</span>
        <span class="n">return_args</span><span class="p">,</span> <span class="n">input_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
        <span class="n">body_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
            <span class="n">body_lines</span><span class="p">,</span>
            <span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">comp</span><span class="o">.</span><span class="n">function_name</span><span class="p">,</span>
            <span class="n">input_args</span><span class="p">,</span>
            <span class="n">return_args</span><span class="p">,</span>
            <span class="n">comp</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">body_lines</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span></div>

<div class="viewcode-block" id="MatlabCodeGenerator.mass_matrix"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.MatlabCodeGenerator.mass_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">mass_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">check_arg</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">ODE</span><span class="p">)</span>
        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;M = eye(</span><span class="si">{</span><span class="n">ode</span><span class="o">.</span><span class="n">num_full_states</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">expr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ode</span><span class="o">.</span><span class="n">state_expressions</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">AlgebraicExpression</span><span class="p">):</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;M(</span><span class="si">{0}</span><span class="s2">,</span><span class="si">{0}</span><span class="s2">) = 0&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">body_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
            <span class="n">body_lines</span><span class="p">,</span>
            <span class="n">ode</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_mass_matrix&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;M&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;The mass matrix of the </span><span class="si">{</span><span class="n">ode</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> ODE&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">body_lines</span><span class="p">))</span></div></div>


<span class="k">class</span> <span class="nc">DOLFINCodeGenerator</span><span class="p">(</span><span class="n">PythonCodeGenerator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for generating a DOLFIN compatible declarations of an ODE from</span>
<span class="sd">    a gotran file</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">default_parameters</span><span class="p">():</span>
        <span class="n">default_params</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">generation</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">state_repr</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">default_params</span><span class="o">.</span><span class="n">states</span><span class="p">,</span> <span class="s2">&quot;representation&quot;</span><span class="p">)</span>
        <span class="n">param_repr</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">default_params</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="s2">&quot;representation&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ParameterDict</span><span class="p">(</span><span class="n">state_repr</span><span class="o">=</span><span class="n">state_repr</span><span class="p">,</span> <span class="n">param_repr</span><span class="o">=</span><span class="n">param_repr</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code_params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Instantiate the class</span>

<span class="sd">        Arguments:</span>
<span class="sd">        ----------</span>
<span class="sd">        code_params : dict</span>
<span class="sd">            Parameters controling the code generation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">code_params</span> <span class="o">=</span> <span class="n">code_params</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">check_kwarg</span><span class="p">(</span><span class="n">code_params</span><span class="p">,</span> <span class="s2">&quot;code_params&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">DOLFINCodeGenerator</span><span class="o">.</span><span class="n">default_parameters</span><span class="p">()</span>
        <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">code_params</span><span class="p">)</span>

        <span class="c1"># Get a whole set of gotran code parameters and update with dolfin</span>
        <span class="c1"># specific options</span>
        <span class="n">generation_params</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">generation</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">generation_params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">default_arguments</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;st&quot;</span> <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">param_repr</span> <span class="o">==</span> <span class="s2">&quot;numerals&quot;</span> <span class="k">else</span> <span class="s2">&quot;stp&quot;</span>
        <span class="p">)</span>
        <span class="n">generation_params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;time&quot;</span>

        <span class="n">generation_params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">index_format</span> <span class="o">=</span> <span class="s2">&quot;[]&quot;</span>
        <span class="n">generation_params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">index_offset</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">generation_params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">representation</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">param_repr</span>

        <span class="n">generation_params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">representation</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">state_repr</span>
        <span class="n">generation_params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span> <span class="o">=</span> <span class="s2">&quot;states&quot;</span>

        <span class="n">generation_params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">array_name</span> <span class="o">=</span> <span class="s2">&quot;body&quot;</span>
        <span class="n">generation_params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">representation</span> <span class="o">=</span> <span class="s2">&quot;named&quot;</span>

        <span class="c1"># Init base class</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DOLFINCodeGenerator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ns</span><span class="o">=</span><span class="s2">&quot;ufl&quot;</span><span class="p">)</span>

        <span class="c1"># Store attributes (over load default PythonCode parameters)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">generation_params</span>

    <span class="k">def</span> <span class="nf">_init_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="n">default_arguments</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">check_arg</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">CodeComponent</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span>
        <span class="n">default_arguments</span> <span class="o">=</span> <span class="n">default_arguments</span> <span class="ow">or</span> <span class="n">params</span><span class="o">.</span><span class="n">default_arguments</span>

        <span class="c1"># Check if comp defines used_states if not use the root components</span>
        <span class="c1"># full_states attribute</span>
        <span class="c1"># FIXME: No need for full_states here...</span>
        <span class="n">states</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">full_states</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">parameters</span>

        <span class="n">num_states</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">num_full_states</span>
        <span class="n">num_parameters</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">num_parameters</span>

        <span class="c1"># Start building body</span>
        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;# Imports&quot;</span><span class="p">,</span> <span class="s2">&quot;import ufl&quot;</span><span class="p">,</span> <span class="s2">&quot;import dolfin&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;s&quot;</span> <span class="ow">in</span> <span class="n">default_arguments</span> <span class="ow">and</span> <span class="n">states</span><span class="p">:</span>

            <span class="n">states_name</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# Assign states&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;assert(isinstance(</span><span class="si">{</span><span class="n">states_name</span><span class="si">}</span><span class="s2">, dolfin.Function))&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;assert(states.function_space().depth() == 1)&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;assert(states.function_space().num_sub_spaces() == </span><span class="si">{</span><span class="n">num_states</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Generate state assign code</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">representation</span> <span class="o">==</span> <span class="s2">&quot;named&quot;</span><span class="p">:</span>

                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">)</span>
                    <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; = dolfin.split(</span><span class="si">{</span><span class="n">states_name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># Add parameters code if not numerals</span>
        <span class="k">if</span> <span class="s2">&quot;p&quot;</span> <span class="ow">in</span> <span class="n">default_arguments</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">representation</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;named&quot;</span><span class="p">,</span>
            <span class="s2">&quot;array&quot;</span><span class="p">,</span>
        <span class="p">]:</span>

            <span class="n">parameters_name</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">array_name</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# Assign parameters&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;assert(isinstance(</span><span class="si">{0}</span><span class="s2">, (dolfin.Function, &quot;</span>
                <span class="s2">&quot;dolfin.Constant)))&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parameters_name</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;if isinstance(</span><span class="si">{</span><span class="n">parameters_name</span><span class="si">}</span><span class="s2">, dolfin.Function):&quot;</span><span class="p">)</span>
            <span class="n">if_closure</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">if_closure</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;assert(</span><span class="si">{</span><span class="n">parameters_name</span><span class="si">}</span><span class="s2">.function_space().depth() == 1)&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">if_closure</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;assert(</span><span class="si">{0}</span><span class="s2">.function_space().num_sub_spaces() &quot;</span>
                <span class="s2">&quot;== </span><span class="si">{1}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parameters_name</span><span class="p">,</span> <span class="n">num_parameters</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">if_closure</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;else:&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;assert(</span><span class="si">{</span><span class="n">parameters_name</span><span class="si">}</span><span class="s2">.value_size() == </span><span class="si">{</span><span class="n">num_parameters</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">],</span>
            <span class="p">)</span>

            <span class="c1"># Generate parameters assign code</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">representation</span> <span class="o">==</span> <span class="s2">&quot;named&quot;</span><span class="p">:</span>

                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">)</span>
                    <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; = dolfin.split(</span><span class="si">{</span><span class="n">parameters_name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># If initilizing results</span>
        <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# Init return args&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">result_name</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">shapes</span><span class="p">[</span><span class="n">result_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">error</span><span class="p">(</span><span class="s2">&quot;expected only result expression with rank 1&quot;</span><span class="p">)</span>

            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result_name</span><span class="si">}</span><span class="s2"> = [ufl.zero()]*</span><span class="si">{</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">body_lines</span>

    <span class="k">def</span> <span class="nf">function_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">include_signature</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="n">check_arg</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">CodeComponent</span><span class="p">)</span>
        <span class="n">check_kwarg</span><span class="p">(</span><span class="n">indent</span><span class="p">,</span> <span class="s2">&quot;indent&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>

        <span class="n">body_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_arguments</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>

        <span class="c1"># Iterate over any body needed to define the dy</span>
        <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">body_expressions</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Comment</span><span class="p">):</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_code</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">expr</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# Return results&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;return </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">[0]&quot;</span>
                            <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">shapes</span><span class="p">[</span><span class="n">result_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
                            <span class="k">else</span> <span class="s2">&quot;dolfin.as_vector(</span><span class="si">{0}</span><span class="s2">)&quot;</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result_name</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">result_name</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">results</span>
                    <span class="p">),</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">include_signature</span><span class="p">:</span>

            <span class="c1"># Add function prototype</span>
            <span class="n">body_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
                <span class="n">body_lines</span><span class="p">,</span>
                <span class="n">comp</span><span class="o">.</span><span class="n">function_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">(</span><span class="n">comp</span><span class="p">),</span>
                <span class="n">comp</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">decorators</span><span class="p">(),</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">body_lines</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">init_states_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate code for setting initial condition</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Start building body</span>
        <span class="n">states</span> <span class="o">=</span> <span class="n">ode</span><span class="o">.</span><span class="n">full_states</span>
        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;# Imports&quot;</span><span class="p">,</span> <span class="s2">&quot;import dolfin&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;# Init values&quot;</span><span class="p">]</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;# </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">=</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">init</span><span class="p">)</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;init_values = [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">init</span><span class="p">)</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">range_check</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;lambda value : value </span><span class="si">{minop}</span><span class="s2"> </span><span class="si">{minvalue}</span><span class="s2"> and &quot;</span> <span class="s2">&quot;value </span><span class="si">{maxop}</span><span class="s2"> </span><span class="si">{maxvalue}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;inf = float(&quot;inf&quot;)&#39;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# State indices and limit checker&quot;</span><span class="p">)</span>

        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;state_ind = dict(</span><span class="si">{0}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">=(</span><span class="si">{1}</span><span class="s2">, </span><span class="si">{2}</span><span class="s2">, </span><span class="si">{3!r}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">state</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">i</span><span class="p">,</span>
                        <span class="n">range_check</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">state</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">_range</span><span class="o">.</span><span class="n">range_formats</span><span class="p">),</span>
                        <span class="n">state</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">_range</span><span class="o">.</span><span class="n">_not_in_str</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;for state_name, value in values.items():&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;if state_name not in state_ind:&quot;</span><span class="p">,</span>
                <span class="p">[</span><span class="s1">&#39;raise ValueError(&quot;{{0}} is not a state.&quot;.format(state_name))&#39;</span><span class="p">],</span>
                <span class="s2">&quot;ind, range_check, not_in_format = state_ind[state_name]&quot;</span><span class="p">,</span>
                <span class="s2">&quot;if not range_check(value):&quot;</span><span class="p">,</span>
                <span class="p">[</span>
                    <span class="s2">&quot;raise ValueError(</span><span class="se">\&quot;</span><span class="s2">While setting &#39;</span><span class="si">{0}</span><span class="s2">&#39; </span><span class="si">{1}</span><span class="se">\&quot;</span><span class="s2">.format(&quot;</span>
                    <span class="s2">&quot;state_name, not_in_format </span><span class="si">% s</span><span class="s2">tr(value)))&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;# Assign value&quot;</span><span class="p">,</span>
                <span class="s2">&quot;init_values[ind] = value&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;return dolfin.Constant(tuple(init_values))&quot;</span><span class="p">)</span>

        <span class="c1"># Add function prototype</span>
        <span class="n">init_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
            <span class="n">body_lines</span><span class="p">,</span>
            <span class="s2">&quot;init_state_values&quot;</span><span class="p">,</span>
            <span class="s2">&quot;**values&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Init values&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">init_function</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">init_parameters_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate code for setting parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="n">ode</span><span class="o">.</span><span class="n">parameters</span>

        <span class="c1"># Start building body</span>
        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;# Imports&quot;</span><span class="p">,</span> <span class="s2">&quot;import dolfin&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;# Param values&quot;</span><span class="p">]</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;# </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">=</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">param</span><span class="o">.</span><span class="n">init</span><span class="p">)</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">parameters</span>
                <span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;param_values = [</span><span class="si">{0}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">init</span><span class="p">)</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">range_check</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;lambda value : value </span><span class="si">{minop}</span><span class="s2"> </span><span class="si">{minvalue}</span><span class="s2"> and &quot;</span> <span class="s2">&quot;value </span><span class="si">{maxop}</span><span class="s2"> </span><span class="si">{maxvalue}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# Parameter indices and limit checker&quot;</span><span class="p">)</span>

        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;parameter_ind = dict(</span><span class="si">{0}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">=(</span><span class="si">{1}</span><span class="s2">, </span><span class="si">{2}</span><span class="s2">, </span><span class="si">{3!r}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">parameter</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">i</span><span class="p">,</span>
                        <span class="n">range_check</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">parameter</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">_range</span><span class="o">.</span><span class="n">range_formats</span><span class="p">),</span>
                        <span class="n">parameter</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">_range</span><span class="o">.</span><span class="n">_not_in_str</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;for param_name, value in values.items():&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;if param_name not in parameter_ind:&quot;</span><span class="p">,</span>
                <span class="p">[</span><span class="s1">&#39;raise ValueError(&quot;{{0}} is not a parameter.&quot;.format(param_name))&#39;</span><span class="p">],</span>
                <span class="s2">&quot;ind, range_check, not_in_format = parameter_ind[param_name]&quot;</span><span class="p">,</span>
                <span class="s2">&quot;if not range_check(value):&quot;</span><span class="p">,</span>
                <span class="p">[</span>
                    <span class="s2">&quot;raise ValueError(</span><span class="se">\&quot;</span><span class="s2">While setting &#39;</span><span class="si">{0}</span><span class="s2">&#39; </span><span class="si">{1}</span><span class="se">\&quot;</span><span class="s2">.format(&quot;</span>
                    <span class="s2">&quot;param_name, not_in_format </span><span class="si">% s</span><span class="s2">tr(value)))&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;# Assign value&quot;</span><span class="p">,</span>
                <span class="s2">&quot;init_values[ind] = value&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;return dolfin.Constant(tuple(param_values))&quot;</span><span class="p">)</span>

        <span class="c1"># Add function prototype</span>
        <span class="n">function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
            <span class="n">body_lines</span><span class="p">,</span>
            <span class="s2">&quot;init_parameter_values&quot;</span><span class="p">,</span>
            <span class="s2">&quot;**values&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Parameter values&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span>


<div class="viewcode-block" id="JuliaCodeGenerator"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.JuliaCodeGenerator">[docs]</a><span class="k">class</span> <span class="nc">JuliaCodeGenerator</span><span class="p">(</span><span class="n">BaseCodeGenerator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Julia Code generator</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Class attributes</span>
    <span class="n">language</span> <span class="o">=</span> <span class="s2">&quot;Julia&quot;</span>
    <span class="n">line_ending</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">closure_start</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">closure_end</span> <span class="o">=</span> <span class="s2">&quot;end&quot;</span>
    <span class="n">line_cont</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span>
    <span class="n">index</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]&quot;</span>
    <span class="n">indent</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">indent_str</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
    <span class="n">to_code</span> <span class="o">=</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">juliacode</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="JuliaCodeGenerator.default_parameters"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.JuliaCodeGenerator.default_parameters">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">default_parameters</span><span class="p">():</span>
        <span class="c1"># Start out with a copy of the global parameters</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">generation</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">default_arguments</span> <span class="o">=</span> <span class="s2">&quot;spt&quot;</span>
        <span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">index_offset</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">params</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">rhs</span><span class="p">[</span><span class="s2">&quot;result_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;dy&quot;</span>
        <span class="n">params</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="s2">&quot;array_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;y&quot;</span>

        <span class="k">return</span> <span class="n">params</span></div>

<div class="viewcode-block" id="JuliaCodeGenerator.args"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.JuliaCodeGenerator.args">[docs]</a>    <span class="k">def</span> <span class="nf">args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build argument str</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span>
        <span class="n">default_arguments</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">params</span><span class="o">.</span><span class="n">default_arguments</span> <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">use_default_arguments</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>

        <span class="n">additional_arguments</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">additional_arguments</span><span class="p">[:]</span>

        <span class="n">skip_result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ret_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">default_arguments</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="o">==</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
                    <span class="n">skip_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span><span class="p">)</span>
                <span class="n">ret_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">arg</span> <span class="o">==</span> <span class="s2">&quot;t&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
                    <span class="n">skip_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">ret_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;dt&quot;</span> <span class="ow">in</span> <span class="n">additional_arguments</span><span class="p">:</span>
                    <span class="n">additional_arguments</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;dt&quot;</span><span class="p">)</span>
                    <span class="n">ret_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">arg</span> <span class="o">==</span> <span class="s2">&quot;p&quot;</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">representation</span> <span class="o">!=</span> <span class="s2">&quot;numerals&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">array_name</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
                    <span class="n">skip_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">array_name</span><span class="p">)</span>
                <span class="n">ret_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">array_name</span><span class="p">)</span>

        <span class="n">ret_args</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">additional_arguments</span><span class="p">)</span>

        <span class="c1"># Arguments with default (None) values</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">in_signature</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">representation</span> <span class="o">!=</span> <span class="s2">&quot;named&quot;</span><span class="p">:</span>
            <span class="n">ret_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">array_name</span><span class="si">}</span><span class="s2">=nothing&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">result_name</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skip_result</span><span class="p">:</span>
                <span class="n">ret_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result_name</span><span class="si">}</span><span class="s2">=nothing&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ret_args</span><span class="p">)</span></div>

<div class="viewcode-block" id="JuliaCodeGenerator.wrap_body_with_function_prototype"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.JuliaCodeGenerator.wrap_body_with_function_prototype">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">wrap_body_with_function_prototype</span><span class="p">(</span><span class="n">body_lines</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrap a passed body of lines with a function prototype</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_arg</span><span class="p">(</span><span class="n">body_lines</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="n">check_arg</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">check_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">check_arg</span><span class="p">(</span><span class="n">comment</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span>

        <span class="n">prototype</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">prototype</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;function </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Wrap comment if any</span>
        <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
            <span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&quot;&quot;&quot;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comment</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">body</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
            <span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&quot;&quot;&quot;&#39;</span><span class="p">)</span>

        <span class="c1"># Extend the body with body lines</span>
        <span class="n">body</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">body_lines</span><span class="p">)</span>

        <span class="c1"># Append body to prototyp</span>
        <span class="n">prototype</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">prototype</span></div>

    <span class="k">def</span> <span class="nf">_init_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp</span><span class="p">):</span>

        <span class="n">check_arg</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">CodeComponent</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">code</span>

        <span class="n">default_arguments</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">params</span><span class="o">.</span><span class="n">default_arguments</span> <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">use_default_arguments</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Check if comp defines used_states if not use the root components</span>
        <span class="c1"># full_states attribute</span>
        <span class="c1"># FIXME: No need for full_states here...</span>
        <span class="n">used_states</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">comp</span><span class="o">.</span><span class="n">used_states</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="s2">&quot;used_states&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">full_states</span>
        <span class="p">)</span>

        <span class="n">used_parameters</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">comp</span><span class="o">.</span><span class="n">used_parameters</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="s2">&quot;used_parameters&quot;</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">parameters</span>
        <span class="p">)</span>

        <span class="n">num_states</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">num_full_states</span>
        <span class="n">num_parameters</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">num_parameters</span>

        <span class="c1"># Start building body</span>
        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s2">&quot;s&quot;</span> <span class="ow">in</span> <span class="n">default_arguments</span> <span class="ow">and</span> <span class="n">used_states</span><span class="p">:</span>

            <span class="n">states_name</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# Assign states&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;@assert length(</span><span class="si">{</span><span class="n">states_name</span><span class="si">}</span><span class="s2">) == </span><span class="si">{</span><span class="n">num_states</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Generate state assign code</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">representation</span> <span class="o">==</span> <span class="s2">&quot;named&quot;</span><span class="p">:</span>

                <span class="c1"># If all states are used</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">used_states</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">full_states</span><span class="p">):</span>
                    <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="n">state</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">full_states</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="o">+</span> <span class="s2">&quot; = &quot;</span>
                        <span class="o">+</span> <span class="n">states_name</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="c1"># If only a limited number of states are used</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">states_name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">]&quot;</span>
                            <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">full_states</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">used_states</span>
                        <span class="p">),</span>
                    <span class="p">)</span>

        <span class="c1"># Add parameters code if not numerals</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="s2">&quot;p&quot;</span> <span class="ow">in</span> <span class="n">default_arguments</span>
            <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">representation</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;named&quot;</span><span class="p">,</span> <span class="s2">&quot;array&quot;</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">used_parameters</span>
        <span class="p">):</span>

            <span class="n">parameters_name</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">array_name</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# Assign parameters&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;@assert length(</span><span class="si">{</span><span class="n">parameters_name</span><span class="si">}</span><span class="s2">) == </span><span class="si">{</span><span class="n">num_parameters</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Generate parameters assign code</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">representation</span> <span class="o">==</span> <span class="s2">&quot;named&quot;</span><span class="p">:</span>

                <span class="c1"># If all parameters are used</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">used_parameters</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">parameters</span><span class="p">):</span>
                    <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">used_parameters</span><span class="p">))</span>
                        <span class="o">+</span> <span class="s2">&quot; = &quot;</span>
                        <span class="o">+</span> <span class="n">parameters_name</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="c1"># If only a limited number of states are used</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">parameters_name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">]&quot;</span>
                            <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">used_parameters</span>
                        <span class="p">),</span>
                    <span class="p">)</span>

        <span class="c1"># If using an array for the body variables</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">representation</span> <span class="o">!=</span> <span class="s2">&quot;named&quot;</span>
            <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">array_name</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">shapes</span>
        <span class="p">):</span>

            <span class="n">body_name</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">array_name</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# Body array </span><span class="si">{</span><span class="n">body_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># If passing the body argument to the method</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">in_signature</span><span class="p">:</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;if </span><span class="si">{</span><span class="n">body_name</span><span class="si">}</span><span class="s2"> == nothing&quot;</span><span class="p">)</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">body_name</span><span class="si">}</span><span class="s2"> = zeros(</span><span class="si">{</span><span class="n">comp</span><span class="o">.</span><span class="n">shapes</span><span class="p">[</span><span class="n">body_name</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">])</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;@assert size(</span><span class="si">{</span><span class="n">body_name</span><span class="si">}</span><span class="s2">) == </span><span class="si">{</span><span class="n">comp</span><span class="o">.</span><span class="n">shapes</span><span class="p">[</span><span class="n">body_name</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">body_name</span><span class="si">}</span><span class="s2"> = zeros(</span><span class="si">{</span><span class="n">comp</span><span class="o">.</span><span class="n">shapes</span><span class="p">[</span><span class="n">body_name</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="c1"># If initelizing results</span>
        <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>

            <span class="n">results</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">results</span><span class="p">[:]</span>

            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">array_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">array_name</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">array_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# Init return args&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">result_name</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">shapes</span><span class="p">[</span><span class="n">result_name</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">flatten</span><span class="p">:</span>
                        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="mi">1</span><span class="p">),)</span>

                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;if </span><span class="si">{</span><span class="n">result_name</span><span class="si">}</span><span class="s2"> == nothing&quot;</span><span class="p">)</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result_name</span><span class="si">}</span><span class="s2"> = zeros(</span><span class="si">{</span><span class="n">shape</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">])</span>
                <span class="c1"># body_lines.append(&quot;else&quot;.format(result_name))</span>
                <span class="c1"># body_lines.append([&quot;assert isinstance({0}, np.ndarray) and &quot;\</span>
                <span class="c1"># &quot;{1}.shape == {2}&quot;.format(result_name, result_name, shape)])</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;@assert size(</span><span class="si">{</span><span class="n">result_name</span><span class="si">}</span><span class="s2">) == </span><span class="si">{</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">body_lines</span>

<div class="viewcode-block" id="JuliaCodeGenerator.function_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.JuliaCodeGenerator.function_code">[docs]</a>    <span class="k">def</span> <span class="nf">function_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">include_signature</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate code for a single function given by a CodeComponent</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">check_arg</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">CodeComponent</span><span class="p">)</span>
        <span class="n">check_kwarg</span><span class="p">(</span><span class="n">indent</span><span class="p">,</span> <span class="s2">&quot;indent&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>

        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">body_lines</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_arguments</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>

        <span class="c1"># Iterate over any body needed to define the dy</span>
        <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">body_expressions</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Comment</span><span class="p">):</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_code</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">expr</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# Return results&quot;</span><span class="p">)</span>
            <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;return </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">result_name</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">shapes</span><span class="p">[</span><span class="n">result_name</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">1</span>
                        <span class="ow">and</span> <span class="n">comp</span><span class="o">.</span><span class="n">shapes</span><span class="p">[</span><span class="n">result_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span>
                        <span class="k">else</span> <span class="n">result_name</span> <span class="o">+</span> <span class="s2">&quot;[0]&quot;</span>
                        <span class="k">for</span> <span class="n">result_name</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">results</span>
                    <span class="p">),</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">include_signature</span><span class="p">:</span>

            <span class="c1"># Add function prototype</span>
            <span class="n">body_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
                <span class="n">body_lines</span><span class="p">,</span>
                <span class="n">comp</span><span class="o">.</span><span class="n">function_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">(</span><span class="n">comp</span><span class="p">),</span>
                <span class="n">comp</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">body_lines</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span></div>

<div class="viewcode-block" id="JuliaCodeGenerator.init_states_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.JuliaCodeGenerator.init_states_code">[docs]</a>    <span class="k">def</span> <span class="nf">init_states_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate code for setting initial condition</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">check_arg</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">ODE</span><span class="p">)</span>

        <span class="c1"># Get all full states</span>
        <span class="n">states</span> <span class="o">=</span> <span class="n">ode</span><span class="o">.</span><span class="n">full_states</span>

        <span class="c1"># Start building body</span>
        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;kwargs = Dict(kwargs)&quot;</span><span class="p">,</span> <span class="s2">&quot;# Init values&quot;</span><span class="p">]</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;# </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">=</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">init</span><span class="p">)</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;init_values = Vector([</span><span class="si">{0}</span><span class="s2">])&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">init</span><span class="p">)</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# State indices and limit checker&quot;</span><span class="p">)</span>

        <span class="c1"># body_lines.append(&quot;state_ind = Dict({0})&quot;.format(\</span>
        <span class="c1">#     &quot;, &quot;.join(&quot;:{0} =&gt; {1}&quot;.format(state.param.name, i) \</span>
        <span class="c1">#               for i, state in enumerate(states, start=1))))</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;state_ind = Dict(</span><span class="si">{0}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="s1">&#39;&quot;</span><span class="si">{0}</span><span class="s1">&quot; =&gt; </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">states</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;for key in keys(kwargs)&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;if haskey(state_ind, key)&quot;</span><span class="p">,</span>
                <span class="p">[</span><span class="s2">&quot;ind = state_ind[key]&quot;</span><span class="p">,</span> <span class="s2">&quot;init_values[ind] = kwargs[key]&quot;</span><span class="p">],</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;return init_values&quot;</span><span class="p">)</span>

        <span class="c1"># Add function prototype</span>
        <span class="n">init_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
            <span class="n">body_lines</span><span class="p">,</span>
            <span class="s2">&quot;init_state_values&quot;</span><span class="p">,</span>
            <span class="s2">&quot;; kwargs...&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Initialize state values&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">init_function</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span></div>

<div class="viewcode-block" id="JuliaCodeGenerator.init_parameters_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.JuliaCodeGenerator.init_parameters_code">[docs]</a>    <span class="k">def</span> <span class="nf">init_parameters_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate code for setting parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">check_arg</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">ODE</span><span class="p">)</span>

        <span class="c1"># Get all parameters</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">ode</span><span class="o">.</span><span class="n">parameters</span>

        <span class="c1"># Start building body</span>
        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;kwargs = Dict(kwargs)&quot;</span><span class="p">,</span> <span class="s2">&quot;# Param values&quot;</span><span class="p">]</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;# </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">=</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">param</span><span class="o">.</span><span class="n">init</span><span class="p">)</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">parameters</span>
                <span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;init_values = Vector([</span><span class="si">{0}</span><span class="s2">])&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">init</span><span class="p">)</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# Parameter indices and limit checker&quot;</span><span class="p">)</span>

        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;param_ind = Dict(</span><span class="si">{0}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="s1">&#39;&quot;</span><span class="si">{0}</span><span class="s1">&quot; =&gt; </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;for key in keys(kwargs)&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;if haskey(param_ind, key)&quot;</span><span class="p">,</span>
                <span class="p">[</span><span class="s2">&quot;ind = param_ind[key]&quot;</span><span class="p">,</span> <span class="s2">&quot;init_values[ind] = kwargs[key]&quot;</span><span class="p">],</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;return init_values&quot;</span><span class="p">)</span>

        <span class="c1"># Add function prototype</span>
        <span class="n">function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
            <span class="n">body_lines</span><span class="p">,</span>
            <span class="s2">&quot;init_parameter_values&quot;</span><span class="p">,</span>
            <span class="s2">&quot;; kwargs...&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Initialize parameter values&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span></div>

<div class="viewcode-block" id="JuliaCodeGenerator.state_name_to_index_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.JuliaCodeGenerator.state_name_to_index_code">[docs]</a>    <span class="k">def</span> <span class="nf">state_name_to_index_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return code for index handling for states</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_arg</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">ODE</span><span class="p">)</span>
        <span class="n">states</span> <span class="o">=</span> <span class="n">ode</span><span class="o">.</span><span class="n">full_states</span>

        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;state_inds = Dict(</span><span class="si">{0}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="s1">&#39;&quot;</span><span class="si">{0}</span><span class="s1">&quot; =&gt; </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">states</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;for state in states&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;if haskey(state_inds, state)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;return state_inds[state]&quot;</span><span class="p">]],</span>
        <span class="p">)</span>
        <span class="c1"># body_lines.append(&quot;end&quot;)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;return state_inds&quot;</span><span class="p">)</span>

        <span class="c1"># Add function prototype</span>
        <span class="n">function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
            <span class="n">body_lines</span><span class="p">,</span>
            <span class="s2">&quot;state_indices&quot;</span><span class="p">,</span>
            <span class="s2">&quot;states...&quot;</span><span class="p">,</span>
            <span class="s2">&quot;State indices&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span></div>

<div class="viewcode-block" id="JuliaCodeGenerator.param_name_to_index_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.JuliaCodeGenerator.param_name_to_index_code">[docs]</a>    <span class="k">def</span> <span class="nf">param_name_to_index_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return code for index handling for parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">check_arg</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">ODE</span><span class="p">)</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="n">ode</span><span class="o">.</span><span class="n">parameters</span>

        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;param_inds = Dict(</span><span class="si">{0}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="s1">&#39;&quot;</span><span class="si">{0}</span><span class="s1">&quot; =&gt; </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;for param in params&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;if haskey(param_inds, param)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;return param_inds[param]&quot;</span><span class="p">]],</span>
        <span class="p">)</span>
        <span class="c1"># body_lines.append(&quot;end&quot;)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;return param_inds&quot;</span><span class="p">)</span>

        <span class="c1"># Add function prototype</span>
        <span class="n">function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
            <span class="n">body_lines</span><span class="p">,</span>
            <span class="s2">&quot;parameter_indices&quot;</span><span class="p">,</span>
            <span class="s2">&quot;params...&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Parameter indices&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span></div>

<div class="viewcode-block" id="JuliaCodeGenerator.monitor_name_to_index_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.JuliaCodeGenerator.monitor_name_to_index_code">[docs]</a>    <span class="k">def</span> <span class="nf">monitor_name_to_index_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">monitored</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return code for index handling for monitored</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_arg</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">ODE</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">expr_str</span> <span class="ow">in</span> <span class="n">monitored</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">ode</span><span class="o">.</span><span class="n">present_ode_objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">expr_str</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Expression</span><span class="p">):</span>
                <span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> is not an intermediate or state expression in &quot;</span>
                    <span class="s2">&quot;the </span><span class="si">{1}</span><span class="s2"> ODE&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">expr_str</span><span class="p">,</span> <span class="n">ode</span><span class="p">),</span>
                <span class="p">)</span>

        <span class="n">body_lines</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;monitor_inds = Dict(</span><span class="si">{0}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="s1">&#39;&quot;</span><span class="si">{0}</span><span class="s1">&quot; =&gt; </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">monitor</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">monitor</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">monitored</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;for monitor in monitored&quot;</span><span class="p">)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;if haskey(monitor_inds, monitor)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;return monitor_inds[monitor]&quot;</span><span class="p">]],</span>
        <span class="p">)</span>
        <span class="c1"># body_lines.append(&quot;end&quot;)</span>
        <span class="n">body_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;return monitor_inds&quot;</span><span class="p">)</span>

        <span class="c1"># Add function prototype</span>
        <span class="n">function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_body_with_function_prototype</span><span class="p">(</span>
            <span class="n">body_lines</span><span class="p">,</span>
            <span class="s2">&quot;monitor_indices&quot;</span><span class="p">,</span>
            <span class="s2">&quot;monitored...&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Monitor indices&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_and_split_lines</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">))</span></div>

<div class="viewcode-block" id="JuliaCodeGenerator.componentwise_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.JuliaCodeGenerator.componentwise_code">[docs]</a>    <span class="k">def</span> <span class="nf">componentwise_code</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ode</span><span class="p">,</span>
        <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">include_signature</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">return_body_lines</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Generation of componentwise_rhs_evaluation code is not &quot;</span>
            <span class="s2">&quot;yet implemented for Julia backend.&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="JuliaCodeGenerator.module_code"><a class="viewcode-back" href="../../../gotran.codegeneration.html#gotran.JuliaCodeGenerator.module_code">[docs]</a>    <span class="k">def</span> <span class="nf">module_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="p">,</span> <span class="n">monitored</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># self.params.functions.rhs[&#39;result_name&#39;] = &#39;dy&#39;</span>

        <span class="c1"># Force class code param to be False</span>
        <span class="n">class_code_param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">class_code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">class_code</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">check_arg</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">ODE</span><span class="p">)</span>
        <span class="n">code_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code_dict</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">monitored</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">class_code</span> <span class="o">=</span> <span class="n">class_code_param</span>

        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;# Gotran generated code for the  &quot;</span><span class="si">{0}</span><span class="s2">&quot; model</span>

<span class="si">{1}</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">ode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">code_list</span><span class="p">),</span>
        <span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, Johan Hake, Henrik Finsberg, Kristian G. Hustad.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>